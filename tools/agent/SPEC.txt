================================================================================
                         AGENT CLI SPECIFICATION
                      Claude Code Agent Manager v1.0
================================================================================

OVERVIEW
--------
The `agent` CLI manages multiple Claude Code instances running in tmux sessions.
It provides spawning, switching, monitoring, and searching across agents.

================================================================================
                              REQUIREMENTS
================================================================================

DEPENDENCIES:
  - bash 4.0+
  - tmux 3.0+
  - fzf (for fuzzy finding)
  - jq (for JSON parsing)
  - claude (Claude Code CLI)

INSTALLATION LOCATION:
  - Binary: ~/.local/bin/agent
  - Library: ~/.local/lib/claude-os/agent/
  - Config: ~/.config/claude-os/agent/
  - Data: ~/.local/share/claude-os/agent/
  - Completions: ~/.local/share/zsh/site-functions/_agent

================================================================================
                              COMMANDS
================================================================================

agent list
----------
Lists all running Claude Code agents.

Output format:
  SLOT  NAME           PROJECT          STATUS   UPTIME
  1     auth-impl      kavara-app       active   2h 15m
  2     codebase-exp   kavara-app       thinking 45m
  3     test-watch     kavara-app       waiting  1h 30m

Flags:
  --json          Output as JSON
  --quiet         Only output agent names

--------------------------------------------------------------------------------

agent spawn [OPTIONS]
---------------------
Spawns a new Claude Code agent in a tmux session.

Options:
  -n, --name <name>       Name for the agent (required if not auto-generated)
  -p, --project <path>    Project directory (default: current directory)
  -t, --template <name>   Use a template
  -s, --sandbox <preset>  Sandbox preset
  --no-focus              Don't focus the new agent
  --background            Run in background (same as --no-focus)

Templates (stored in ~/.config/claude-os/agent/templates/):
  explorer      Read-only exploration mode
  implementer   Full write access
  reviewer      Code review mode
  debugger      Debug mode with verbose logging
  watcher       Background monitoring

Example:
  agent spawn -n auth-impl -p ~/projects/kavara-app -t implementer

--------------------------------------------------------------------------------

agent focus <name|slot>
-----------------------
Switches focus to the specified agent.

Arguments:
  name    Agent name (fuzzy matched)
  slot    Slot number (1-9)

Example:
  agent focus auth       # Fuzzy matches to auth-impl
  agent focus 1          # Focus agent in slot 1

--------------------------------------------------------------------------------

agent status [name]
-------------------
Shows detailed status for an agent (or all agents if no name given).

Output includes:
  - Agent name and slot
  - Project directory
  - Current status (active, thinking, waiting, idle, error)
  - Uptime
  - Last activity
  - Context usage (if available)
  - Current task (if available)

Flags:
  --json          Output as JSON
  --watch         Continuously update (like top)

--------------------------------------------------------------------------------

agent kill <name|slot>
----------------------
Gracefully stops an agent.

Flags:
  --force         Force kill without graceful shutdown
  --all           Kill all agents (requires confirmation)

--------------------------------------------------------------------------------

agent logs <name|slot>
----------------------
Streams the output of an agent.

Flags:
  -f, --follow    Follow log output (default)
  --no-follow     Don't follow, just show recent
  -n <lines>      Number of lines to show (default: 100)
  --since <time>  Show logs since timestamp

--------------------------------------------------------------------------------

agent search <query>
--------------------
Searches across all agent outputs.

Arguments:
  query           Search query (supports regex)

Flags:
  -a, --agent <name>    Limit to specific agent
  -i, --ignore-case     Case insensitive search
  -c, --context <n>     Show n lines of context (default: 2)
  --json                Output as JSON

Output format:
  AGENT          LINE  MATCH
  auth-impl      245   "implementing authentication flow..."
  codebase-exp   89    "found auth patterns in Services/"

--------------------------------------------------------------------------------

agent pause <name|slot>
-----------------------
Pauses an agent (preserves session, stops processing).

Note: Pausing sends SIGSTOP to the claude process.

--------------------------------------------------------------------------------

agent resume <name|slot>
------------------------
Resumes a paused agent.

Note: Resuming sends SIGCONT to the claude process.

--------------------------------------------------------------------------------

agent snapshot [OPTIONS]
------------------------
Saves agent state for later restoration.

Flags:
  --all           Snapshot all agents
  -n, --name <n>  Name for the snapshot

--------------------------------------------------------------------------------

agent restore <snapshot>
------------------------
Restores agents from a snapshot.

================================================================================
                              DATA STRUCTURES
================================================================================

AGENT METADATA (stored in ~/.local/share/claude-os/agent/agents.json):
{
  "agents": {
    "auth-impl": {
      "slot": 1,
      "name": "auth-impl",
      "project": "/home/user/projects/kavara-app",
      "template": "implementer",
      "sandbox": "implement",
      "tmux_session": "claude-agent-auth-impl",
      "pid": 12345,
      "created": "2024-01-15T10:30:00Z",
      "status": "active",
      "last_activity": "2024-01-15T12:45:00Z"
    }
  },
  "next_slot": 2,
  "max_slots": 9
}

TEMPLATE FORMAT (stored in ~/.config/claude-os/agent/templates/):
{
  "name": "explorer",
  "description": "Read-only exploration mode",
  "sandbox": "explore",
  "claude_args": ["--no-edit"],
  "env": {
    "CLAUDE_READONLY": "1"
  },
  "prompt_prefix": "You are in exploration mode. Do not make changes."
}

================================================================================
                              TMUX INTEGRATION
================================================================================

SESSION NAMING:
  claude-agent-<name>

WINDOW LAYOUT:
  - Single window per agent
  - Window title shows agent name and status
  - Status line shows context usage

STATUS DETECTION:
  - Parse tmux pane content for Claude's status indicators
  - Look for "Thinking...", ">" prompt, error messages
  - Update agent metadata on status change

================================================================================
                              STATUS INDICATORS
================================================================================

STATUS DETERMINATION:
  1. Check if tmux session exists
  2. Check if claude process is running
  3. Parse recent output for status indicators:
     - "Thinking" or spinner -> thinking
     - Waiting for input ("> ") -> idle
     - Tool execution output -> active
     - Error messages -> error
     - Paused (SIGSTOP) -> paused

================================================================================
                              SLOT MANAGEMENT
================================================================================

- Slots 1-9 map to keybindings Super+1-9
- When agent is killed, slot is freed
- New agents get lowest available slot
- Slots can be manually reassigned

================================================================================
                              ERROR HANDLING
================================================================================

- If tmux session doesn't exist, mark agent as dead
- If project directory doesn't exist, warn but allow spawn
- If template doesn't exist, error with available templates
- Network errors should not crash the agent manager

================================================================================
                              CONFIGURATION
================================================================================

CONFIG FILE (~/.config/claude-os/agent/config.yaml):
  max_agents: 9
  default_template: implementer
  default_sandbox: implement
  auto_focus: true
  log_retention_days: 7
  snapshot_retention_days: 30

================================================================================
                              ZSH COMPLETIONS
================================================================================

Complete:
  - Subcommands
  - Agent names (from agents.json)
  - Template names (from templates/)
  - Sandbox presets
  - Flags for each subcommand

================================================================================
                              OUTPUT STYLING
================================================================================

COLORS:
  - Green: active status
  - Blue: thinking status
  - Yellow: waiting status
  - White: idle status
  - Red: error status
  - Cyan: agent names
  - Bold: headers

TABLE FORMAT:
  - Aligned columns
  - Header row
  - No trailing whitespace

================================================================================
                              TESTING REQUIREMENTS
================================================================================

1. Unit tests for each function
2. Integration tests for tmux operations
3. Test agent lifecycle (spawn -> focus -> kill)
4. Test search across multiple agents
5. Test slot management (allocation, freeing, limits)

================================================================================
