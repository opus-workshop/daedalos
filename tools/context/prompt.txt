================================================================================
                        CONTEXT CLI BUILD PROMPT
               Claude Context Window Management v1.0
================================================================================

OVERVIEW
--------
The `context` CLI helps visualize and manage Claude's context window usage.
It shows what's consuming context, provides warnings at thresholds, and
offers tools to optimize context usage during long sessions.

================================================================================
                              YOUR TASK
================================================================================

Build a CLI tool that monitors and manages Claude Code context usage.

COMMANDS:
  context status              Show current context budget
  context breakdown           Detailed breakdown by category
  context files               Show files currently in context
  context compact             Suggest/apply context compaction
  context checkpoint [name]   Save context state for resumption
  context restore <name>      Restore from checkpoint

================================================================================
                              HOW IT WORKS
================================================================================

CONTEXT TRACKING:
- Claude Code stores conversation in ~/.claude/projects/<id>/
- Parse conversation history to estimate token counts
- Track which files have been read
- Monitor total context accumulation

TOKEN ESTIMATION:
- Use tiktoken or simple heuristics (4 chars ≈ 1 token)
- Track: system prompt, conversation, tool results, file contents
- Estimate remaining capacity

================================================================================
                              ARCHITECTURE
================================================================================

context/
  bin/
    context                 # Main executable (Python recommended)
  src/
    context/
      __init__.py
      cli.py               # Click CLI
      tracker.py           # Context tracking
      estimator.py         # Token estimation
      visualizer.py        # Output formatting
  install.sh
  README.txt

================================================================================
                              KEY IMPLEMENTATION
================================================================================

ESTIMATOR (src/context/estimator.py):
-------------------------------------
import tiktoken

class TokenEstimator:
    def __init__(self):
        try:
            self.encoder = tiktoken.encoding_for_model("gpt-4")
        except:
            self.encoder = None

    def count(self, text: str) -> int:
        if self.encoder:
            return len(self.encoder.encode(text))
        # Fallback: ~4 chars per token
        return len(text) // 4

TRACKER (src/context/tracker.py):
---------------------------------
from pathlib import Path
import json

class ContextTracker:
    def __init__(self, project_path: str = None):
        self.claude_dir = Path.home() / '.claude'
        self.project_path = project_path or self._detect_project()

    def get_conversation_tokens(self) -> dict:
        # Read conversation history
        history_file = self._find_history()
        if not history_file:
            return {'total': 0, 'breakdown': {}}

        tokens = {
            'system': 0,
            'user': 0,
            'assistant': 0,
            'tool_results': 0,
            'files_read': 0
        }

        # Parse and estimate
        with open(history_file) as f:
            for line in f:
                entry = json.loads(line)
                role = entry.get('role', 'unknown')
                content = entry.get('content', '')
                tokens[role] = tokens.get(role, 0) + self.estimator.count(content)

        return tokens

    def get_status(self) -> dict:
        tokens = self.get_conversation_tokens()
        total = sum(tokens.values())
        max_context = 200000  # Claude's context window

        return {
            'used': total,
            'max': max_context,
            'percentage': (total / max_context) * 100,
            'breakdown': tokens,
            'remaining': max_context - total
        }

VISUALIZER (src/context/visualizer.py):
---------------------------------------
def format_status(status: dict) -> str:
    pct = status['percentage']
    used = status['used']
    max_ctx = status['max']

    # Progress bar
    bar_width = 40
    filled = int(bar_width * pct / 100)
    bar = '█' * filled + '░' * (bar_width - filled)

    # Color based on usage
    if pct < 50:
        color = '\033[32m'  # Green
    elif pct < 70:
        color = '\033[33m'  # Yellow
    elif pct < 85:
        color = '\033[38;5;208m'  # Orange
    else:
        color = '\033[31m'  # Red

    reset = '\033[0m'

    output = []
    output.append("┌─────────────────────────────────────────────────────────────────┐")
    output.append("│ CONTEXT BUDGET                                                  │")
    output.append("├─────────────────────────────────────────────────────────────────┤")
    output.append(f"│ {color}{bar}{reset} {pct:5.1f}%                     │")
    output.append(f"│ Used: {used:,} / {max_ctx:,} tokens                              │")
    output.append("│                                                                 │")
    output.append("│ Breakdown:                                                      │")

    for category, count in status['breakdown'].items():
        pct_cat = (count / used * 100) if used > 0 else 0
        output.append(f"│   {category:<15} {count:>8,} tokens ({pct_cat:4.1f}%)              │")

    output.append("│                                                                 │")

    if pct >= 70:
        output.append("│ ⚠️  Consider: context compact                                   │")

    output.append("└─────────────────────────────────────────────────────────────────┘")

    return '\n'.join(output)

CLI (src/context/cli.py):
-------------------------
import click
from .tracker import ContextTracker
from .visualizer import format_status, format_breakdown

@click.group()
def cli():
    pass

@cli.command()
def status():
    """Show context budget status."""
    tracker = ContextTracker()
    status = tracker.get_status()
    click.echo(format_status(status))

@cli.command()
def breakdown():
    """Show detailed breakdown."""
    tracker = ContextTracker()
    status = tracker.get_status()
    click.echo(format_breakdown(status))

@cli.command()
def files():
    """Show files in context."""
    tracker = ContextTracker()
    files = tracker.get_files_in_context()
    for f in files:
        click.echo(f"  {f['path']} ({f['tokens']:,} tokens)")

@cli.command()
@click.option('--apply', is_flag=True, help='Apply suggested compaction')
def compact(apply):
    """Suggest context compaction strategies."""
    tracker = ContextTracker()
    suggestions = tracker.get_compaction_suggestions()

    for s in suggestions:
        click.echo(f"  • {s['description']}")
        click.echo(f"    Saves ~{s['savings']:,} tokens")

    if apply:
        # Apply compaction strategies
        pass

================================================================================
                              OUTPUT EXAMPLE
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│ CONTEXT BUDGET                                                  │
├─────────────────────────────────────────────────────────────────┤
│ ████████████████████████░░░░░░░░░░░░░░  62.4%                  │
│ Used: 124,800 / 200,000 tokens                                 │
│                                                                 │
│ Breakdown:                                                      │
│   system           8,200 tokens ( 6.6%)                        │
│   conversation    45,300 tokens (36.3%)                        │
│   tool_results    52,100 tokens (41.7%)                        │
│   files_read      19,200 tokens (15.4%)                        │
│                                                                 │
│ Largest items:                                                  │
│   • SchedulingEngine.swift (8,400 tokens)                      │
│   • grep results "Engine" (6,200 tokens)                       │
│   • TodayView.swift (4,800 tokens)                             │
└─────────────────────────────────────────────────────────────────┘

================================================================================
                              BUILD CHECKLIST
================================================================================

[ ] Create directory structure
[ ] Implement token estimator (with tiktoken optional)
[ ] Implement context tracker
[ ] Implement visualizer with colored output
[ ] Create CLI with all commands
[ ] Add compaction suggestions
[ ] Implement checkpoint/restore
[ ] Write tests
[ ] Create install.sh
[ ] Write README.txt

================================================================================
