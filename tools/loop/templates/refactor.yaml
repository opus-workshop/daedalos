# Refactor Loop Template
# Safe refactoring with continuous test verification

name: refactor
description: Safe refactoring with test preservation

defaults:
  max_iterations: 10
  agent: auto

env:
  REFACTOR_GOAL: "{{goal}}"
  TEST_CMD: "{{test_cmd}}"
  LINT_CMD: "{{lint_cmd}}"

loops:
  - id: verify-baseline
    prompt: |
      First, verify all tests pass before refactoring.
      If tests fail, fix them first without changing the refactoring target.
    promise: "{{test_cmd}}"
    max_iterations: 3

  - id: refactor
    prompt: |
      Refactor the codebase with this goal:
      {{goal}}

      Rules:
      - Make small, incremental changes
      - Keep tests passing at all times
      - Preserve existing behavior
      - Improve code quality without changing functionality

      Common refactoring moves:
      - Extract method/function
      - Inline temporary
      - Rename for clarity
      - Remove dead code
      - Simplify conditionals
      - Extract class/module
    promise: "{{test_cmd}} && {{lint_cmd}}"
    depends_on: [verify-baseline]
    max_iterations: 10

  - id: cleanup
    prompt: |
      Final cleanup pass:
      - Remove any TODO comments you added
      - Ensure consistent formatting
      - Update any affected documentation
      - Remove unused imports
    promise: "{{test_cmd}} && {{lint_cmd}}"
    depends_on: [refactor]
    max_iterations: 3

on_complete:
  - "echo 'Refactoring complete: {{goal}}'"

on_failure:
  - "echo 'Refactoring failed - rolling back'"
  - "loop rollback {{failed_loop}} initial"
