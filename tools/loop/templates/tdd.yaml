# TDD - Test-Driven Development Loop Template
# Red -> Green -> Refactor

name: tdd
description: Test-Driven Development cycle - write failing test, make it pass, refactor

defaults:
  max_iterations: 15
  agent: auto

env:
  FEATURE: "{{feature}}"
  TEST_CMD: "{{test_cmd}}"

loops:
  - id: red
    prompt: |
      Write a failing test for the following feature:
      {{feature}}

      The test should:
      - Be minimal and focused on one behavior
      - Use the project's existing test patterns
      - Fail for the right reason (missing implementation, not syntax error)
    promise: "{{test_cmd}} 2>&1 | grep -qE 'FAIL|failed|failing|Error'"
    max_iterations: 5

  - id: green
    prompt: |
      Make the failing test pass with the minimal implementation.

      Feature: {{feature}}

      Rules:
      - Write just enough code to make the test pass
      - Don't add extra functionality
      - Don't optimize yet
      - Keep it simple
    promise: "{{test_cmd}}"
    depends_on: [red]
    max_iterations: 10

  - id: refactor
    prompt: |
      Refactor the code while keeping all tests passing.

      Consider:
      - Remove duplication
      - Improve naming
      - Simplify logic
      - Extract functions if needed

      Do NOT:
      - Add new features
      - Change behavior
      - Break tests
    promise: "{{test_cmd}}"
    depends_on: [green]
    max_iterations: 5

on_complete:
  - "echo 'TDD cycle complete for: {{feature}}'"

on_failure:
  - "echo 'TDD cycle failed at loop: {{failed_loop}}'"
  - "loop rollback {{failed_loop}} initial"
