#!/usr/bin/env bash
#===============================================================================
#     __  __   _   __   ____     ____
#    / / / /  / | / /  / __ \   / __ \
#   / / / /  /  |/ /  / / / /  / / / /
#  / /_/ /  / /|  /  / /_/ /  / /_/ /
#  \____/  /_/ |_/  /_____/   \____/
#
#           File-Level Time Machine
#===============================================================================

set -euo pipefail

#-------------------------------------------------------------------------------
# Script Location & Library Loading
#-------------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
SCHEMA_DIR="${SCRIPT_DIR}/../schema"

# Load library files
source "${LIB_DIR}/common.sh"
source "${LIB_DIR}/database.sh"
source "${LIB_DIR}/backup.sh"
source "${LIB_DIR}/timeline.sh"
source "${LIB_DIR}/commands.sh"
source "${LIB_DIR}/watch.sh"

#-------------------------------------------------------------------------------
# Initialization
#-------------------------------------------------------------------------------

# Ensure database exists
init_database

#-------------------------------------------------------------------------------
# Main
#-------------------------------------------------------------------------------

main() {
    local cmd="${1:-timeline}"

    case "$cmd" in
        timeline)
            shift || true
            cmd_timeline "$@"
            ;;
        last)
            shift
            cmd_last "$@"
            ;;
        to)
            shift
            cmd_to "$@"
            ;;
        preview)
            shift
            cmd_preview "$@"
            ;;
        diff)
            shift
            cmd_diff "$@"
            ;;
        checkpoint|cp)
            shift
            cmd_checkpoint "$@"
            ;;
        watch)
            shift
            cmd_watch "$@"
            ;;
        record)
            shift
            cmd_record "$@"
            ;;
        status)
            shift || true
            cmd_status "$@"
            ;;
        cleanup)
            shift
            cmd_cleanup "$@"
            ;;
        daemon)
            shift
            case "${1:-status}" in
                start)  shift; start_daemon "$@" ;;
                stop)   stop_daemon ;;
                status) daemon_status ;;
                *)      die "Unknown daemon command: $1" ;;
            esac
            ;;
        help|--help|-h)
            show_help
            ;;
        --version)
            echo "undo $UNDO_VERSION"
            ;;
        *)
            die "Unknown command: $cmd (try 'undo help')"
            ;;
    esac
}

main "$@"
