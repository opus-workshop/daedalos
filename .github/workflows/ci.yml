name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - uses: cachix/cachix-action@v14
        with:
          name: daedalos
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true

      - name: Check flake
        run: nix flake check

      - name: Build all packages
        run: nix build .#daedalos

      - name: Test tool help commands
        run: |
          nix develop -c bash -c '
            set -e
            echo "Testing tool help commands..."

            # AI-focused tools
            loop --help
            verify --help
            undo --help
            project --help
            codex --help
            context --help
            error-db --help
            scratch --help
            agent --help
            sandbox --help
            mcp-hub --help
            lsp-pool --help

            # Human-focused tools
            daedalos-env --help
            notify --help
            session --help
            secrets --help
            pair --help
            handoff --help
            review --help
            focus --help
            metrics --help
            template --help
            container --help
            remote --help
            backup --help

            # Supervision tools
            observe --help
            gates --help
            journal --help

            echo "All tools respond to --help"
          '

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on bash tools
        run: |
          find daedalos-tools -name '*.sh' -o -name 'bin/*' -type f | while read f; do
            # Skip if not a bash script
            if head -1 "$f" | grep -q 'bash\|sh'; then
              echo "Checking $f"
              shellcheck -x "$f" || true
            fi
          done

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Check Nix formatting
        run: |
          nix run nixpkgs#nixfmt -- --check flake.nix || echo "Nix formatting could be improved"
