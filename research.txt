================================================================================
                    DAEDALOS DEVELOPMENT LOG
================================================================================

================================================================================
SESSION: 2026-01-09 - Loop Tool Implementation
================================================================================

Built the `loop` tool - THE CORE iteration primitive of Daedalos.

"A loop is not a feature. A loop is how intelligent work gets done."

WHAT WAS BUILT:
---------------

tools/loop/
├── loop                      # Main CLI (Bash) - 580 lines
├── loopd                     # Background daemon (Python) - 450 lines
├── lib/
│   ├── __init__.py          # Package exports
│   ├── promise.py           # Promise verification
│   ├── checkpoint.py        # Btrfs + Git backends
│   ├── agent.py             # OpenCode, Claude, Aider adapters
│   ├── state.py             # Core loop execution engine
│   ├── bestofn.py           # CePO parallel exploration
│   ├── workflow.py          # Multi-loop coordination
│   └── notify.py            # Cross-platform notifications
├── templates/
│   ├── tdd.yaml             # Test-Driven Development
│   ├── bugfix.yaml          # Bug fixing with regression prevention
│   ├── refactor.yaml        # Safe refactoring
│   ├── feature.yaml         # Full feature implementation
│   ├── security.yaml        # Security hardening
│   └── performance.yaml     # Performance optimization
└── completions/
    ├── loop.bash            # Bash completions
    ├── loop.zsh             # Zsh completions
    └── loop.fish            # Fish completions

CAPABILITIES:
-------------

Core Commands:
  loop start "task" --promise "cmd"   Start iterating until promise met
  loop status [id]                    Show loop status
  loop watch <id>                     Live execution view
  loop pause/resume/cancel <id>       Control running loops
  loop inject <id> <context>          Add context mid-loop
  loop checkpoint/rollback            Manage checkpoints
  loop history <id>                   Show iteration history

Advanced Features:
  --best-of 3                         CePO parallel exploration
  loop workflow run file.yaml         Multi-loop coordination
  loop template list/show             Pre-built workflow templates

Agent Support:
  - OpenCode (FOSS default)
  - Claude Code CLI
  - Aider
  - Cursor (placeholder)
  - Custom commands

Checkpoint Backends:
  - Btrfs (instant snapshots)
  - Git (universal fallback)
  - None (speed over safety)

ARCHITECTURE NOTES:
-------------------

The loop tool embodies the core Daedalos philosophy:
1. ITERATE UNTIL DONE - Single-pass inference is a myth
2. CHECKPOINTS EVERYWHERE - Every iteration creates a rollback point
3. AGENT AGNOSTIC - Works with any AI coding agent
4. FOSS BY DESIGN - OpenCode is the default, no vendor lock-in

The state management system persists loop state to JSON, enabling:
- Pause and resume across sessions
- Post-mortem analysis of failed loops
- Progress inspection while running

NEXT STEPS:
-----------

Phase 2 continues with building other tools:
- verify: Universal lint/type/build/test
- undo: File-level timeline navigation
- project: Pre-computed codebase intelligence
- sandbox: True filesystem isolation
- agent: Multi-agent orchestration
- mcp-hub: MCP server management
- lsp-pool: Pre-warmed language servers
- error-db: Error pattern database
- context: Context window management
- codex: Semantic code search

META:
-----

This tool was built BY the loop philosophy - iterating until the
implementation matched the specification. How fitting.

SELF-TEST (2026-01-09):
-----------------------

Successfully tested the loop tool on itself!

Command:
  ./loop start "Create tests for verify_promise" --promise "pytest tests/" --agent claude

Result:
  - Loop ID: 0x7NfsB3
  - Status: COMPLETED in 1 iteration
  - Claude wrote tests/test_promise.py with 3 test cases
  - All tests pass!

The loop tool can now bootstrap its own development. Glorious.

================================================================================

================================================================================
SESSION: 2026-01-09 - Phase 2 Continues: Building More Tools
================================================================================

(Tools built in previous session - see tool directories)

================================================================================
SESSION: 2026-01-09 - Full Stack Installer Created
================================================================================

Created install.sh to teach all Claude agents about Daedalos tools systemwide.

WHAT WAS BUILT:
---------------

install.sh - Full stack installer that:

1. PATH SETUP
   - Creates ~/.local/bin symlinks for all tools
   - Adds PATH to shell rc files
   - Tools become globally callable

2. CLAUDE CODE INTEGRATION
   - Appends tool documentation to ~/.claude/CLAUDE.md
   - Adds Bash permissions to ~/.claude/settings.json
   - Registers mcp-hub as MCP server (user scope)

3. DAEMON AUTOSTART (macOS)
   - Creates launchd plists for loopd, mcp-hub, undod
   - Daemons start on login, restart on crash
   - Logs to ~/.local/share/daedalos/<daemon>/

4. OLLAMA INTEGRATION
   - Creates ~/.config/daedalos/ollama.yaml
   - Recommends qwen2.5-coder:14b model
   - Checks if model is pulled

5. OPENCODE CONFIGURATION
   - Creates ~/.config/opencode/config.yaml
   - Points to local Ollama instance
   - Configures mcp-hub as MCP endpoint

uninstall.sh - Clean removal of all components

DIRECTORIES CREATED:
--------------------

~/.local/bin/              # Tool symlinks
~/.config/daedalos/        # Per-tool configs
~/.local/share/daedalos/   # State and history
~/Library/LaunchAgents/    # Daemon plists (macOS)

AGENT INTEGRATION STRATEGY:
---------------------------

For Claude Code:
  - CLAUDE.md documentation (always loaded)
  - settings.json permissions (auto-allow)
  - MCP server registration

For OpenCode/Aider/etc:
  - Tools in PATH
  - mcp-hub as central MCP broker
  - Config files for each agent

The key insight: CLI tools are universal. Put them in PATH and
document them - any agent can use them. MCP provides richer
integration for agents that support it.

OLLAMA MODELS:
--------------

User has Ollama 0.13.5 installed. Recommended models:

1. CODING MODEL (for agents):
   ollama pull qwen2.5-coder:14b

2. EMBEDDING MODEL (for codex semantic search):
   ollama pull nomic-embed-text

The embedding model enables fully local semantic code search:
- codex uses nomic-embed-text to create vector embeddings
- Embeddings stored in SQLite at ~/.local/share/daedalos/codex/
- No external API calls needed
- Works offline

Alternative embedding models:
- mxbai-embed-large: Higher quality, larger (1024 dim)
- snowflake-arctic-embed: Optimized for retrieval
- all-minilm: Lightweight, fast

Config: ~/.config/daedalos/codex/config.yaml

This provides local LLM support for OpenCode + semantic search,
making the full stack FOSS-compatible (no API keys required).

================================================================================
SESSION: 2026-01-09 - Integration Testing & MCP Server
================================================================================

Verified end-to-end functionality and fixed integration bugs.

DAEDALOS-MCP SERVER:
--------------------

Created a unified MCP server exposing ALL Daedalos tools to Claude:

tools/daedalos-mcp/
├── src/daedalos_mcp/
│   ├── __init__.py     # MCP server with all tool definitions
│   └── __main__.py     # Entry point
├── pyproject.toml
├── install.sh
└── README.txt

Exposes 22 tools:
  - loop_start, loop_status, loop_stop
  - verify
  - undo_checkpoint, undo_last, undo_timeline, undo_restore
  - project_info, project_symbols, project_tree
  - codex_search, codex_index
  - context_estimate, context_breakdown
  - error_match, error_add
  - scratch_new, scratch_list, scratch_destroy
  - agent_spawn, agent_list, agent_focus, agent_search, agent_kill

BUGS FIXED:
-----------

1. LOOP SYMLINK RESOLUTION
   Problem: `~/.local/bin/loop` failed when run from other directories
   Cause: BASH_SOURCE[0] returned symlink path, not target
   Fix: Added symlink resolution loop before setting SCRIPT_DIR

2. MCP CLI MISMATCHES
   Fixed argument mapping to match actual CLIs:
   - project_info: "info" -> "summary"
   - project_symbols: "symbols" -> "search *"
   - undo_timeline: "--limit" -> "-n"
   - undo_restore: "restore" -> "to"
   - loop_start: "--max" -> "-n"

END-TO-END TEST:
----------------

Command:
  loop start "create file test.txt containing hello world" \
    --promise "grep -q hello test.txt" -n 2 --agent claude

Result:
  - Loop ID: t8tQaWE7
  - Status: COMPLETED in 1 iteration
  - Claude created test.txt with "hello world"
  - Promise verified successfully

The full stack works: MCP server -> CLI tools -> Claude agent -> verification

TOOL STATUS:
------------

All Phase 2 tools are implemented and installed:
  ~/.local/bin/loop       OK (symlink fixed)
  ~/.local/bin/verify     OK
  ~/.local/bin/undo       OK
  ~/.local/bin/project    OK
  ~/.local/bin/codex      OK
  ~/.local/bin/context    OK
  ~/.local/bin/error-db   OK
  ~/.local/bin/scratch    OK
  ~/.local/bin/agent      OK
  ~/.local/bin/sandbox    OK
  ~/.local/bin/mcp-hub    OK
  ~/.local/bin/lsp-pool   OK

NOTE: MCP server needs restart after edits (python module cached).

WHAT'S LEFT:
------------

1. Real-world usage testing
2. Phase 3: NixOS ISO/installer (future)

================================================================================
SESSION: 2026-01-09 - Local Embeddings & NixOS Packaging
================================================================================

Integrated local Ollama embeddings for semantic search and created NixOS flake.

LOCAL EMBEDDINGS:
-----------------

1. Pulled nomic-embed-text model (274MB)
   ollama pull nomic-embed-text

2. Fixed codex embedder to use Ollama HTTP API:
   - Changed from CLI `ollama embeddings` (doesn't exist) to HTTP API
   - URL: http://localhost:11434/api/embeddings
   - Returns 768-dimensional vectors

3. Fixed empty string fallback bug:
   - Empty chunks were causing fallback to TF-IDF
   - Now handles empty/whitespace gracefully

SEMANTIC SEARCH TEST:
---------------------

  codex status
  -> Backend: ollama
  -> Files: 165, Chunks: 802

  codex search "error handling and recovery"
  -> Found: tools/loop/lib/checkpoint.py
  -> Found: tools/error-db/errordb/database.py
  -> Semantic matching works!

NIXOS FLAKE:
------------

Created flake.nix with:

1. Individual package derivations for all 12 tools
2. Combined `daedalos` package (symlinkJoin)
3. Development shell with all tools
4. NixOS module for system integration

Usage:
  nix develop            # Dev shell with all tools
  nix build .#loop       # Build individual tool
  nix build              # Build all tools

NixOS module options:
  services.daedalos.enable = true
  services.daedalos.defaultAgent = "opencode"
  services.daedalos.enableDaemons = true

FILES CREATED:
  flake.nix              # Main flake definition
  nix/README.txt         # NixOS integration docs

CURRENT STATE:
--------------

Phase 2 COMPLETE:
- All 12 tools implemented and working
- MCP server exposing tools to Claude
- Local semantic search with Ollama
- NixOS flake for reproducible builds
- Full end-to-end testing passed

Next:
- Phase 3: Full NixOS distribution (ISO builder, installer)
- Real-world usage on actual projects

================================================================================
