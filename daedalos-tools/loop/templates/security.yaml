# Security Loop Template
# Security hardening and vulnerability fixing

name: security
description: Security hardening loop

defaults:
  max_iterations: 10
  agent: auto

env:
  SECURITY_GOAL: "{{goal}}"
  TEST_CMD: "{{test_cmd}}"
  SECURITY_SCAN: "{{security_scan_cmd}}"

loops:
  - id: audit
    prompt: |
      Perform a security audit for:
      {{goal}}

      Look for:
      - Input validation issues
      - SQL injection vulnerabilities
      - XSS vulnerabilities
      - Authentication/authorization flaws
      - Sensitive data exposure
      - Insecure dependencies

      Create a list of findings (even if empty).
    promise: "test -f SECURITY_AUDIT.txt"
    max_iterations: 3

  - id: fix-critical
    prompt: |
      Fix any critical security issues found in the audit.

      Priority order:
      1. Remote code execution
      2. SQL injection
      3. Authentication bypass
      4. Sensitive data exposure

      Make targeted fixes. Don't refactor unrelated code.
    promise: "{{test_cmd}} && {{security_scan_cmd}}"
    depends_on: [audit]
    max_iterations: 10

  - id: harden
    prompt: |
      Apply security hardening:
      - Add input validation where missing
      - Use parameterized queries
      - Escape output appropriately
      - Add security headers
      - Review error messages for information leakage
    promise: "{{test_cmd}} && {{security_scan_cmd}}"
    depends_on: [fix-critical]
    max_iterations: 5

  - id: verify
    prompt: |
      Final security verification:
      - Re-run security scans
      - Verify all fixes are in place
      - Remove SECURITY_AUDIT.txt
    promise: "{{security_scan_cmd}} && ! test -f SECURITY_AUDIT.txt"
    depends_on: [harden]
    max_iterations: 3

on_complete:
  - "echo 'Security hardening complete'"
  - "rm -f SECURITY_AUDIT.txt"

on_failure:
  - "echo 'Security hardening incomplete - manual review needed'"
