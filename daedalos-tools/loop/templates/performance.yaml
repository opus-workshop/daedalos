# Performance Loop Template
# Performance optimization with benchmarking

name: performance
description: Performance optimization loop with benchmarking

defaults:
  max_iterations: 10
  agent: auto

env:
  PERF_GOAL: "{{goal}}"
  TEST_CMD: "{{test_cmd}}"
  BENCH_CMD: "{{bench_cmd}}"
  TARGET_METRIC: "{{target}}"

loops:
  - id: baseline
    prompt: |
      Establish performance baseline for:
      {{goal}}

      Run benchmarks and record current metrics.
      Create a PERF_BASELINE.txt file with results.
    promise: "test -f PERF_BASELINE.txt"
    max_iterations: 2

  - id: profile
    prompt: |
      Profile the code to identify bottlenecks.

      Goal: {{goal}}
      Target: {{target}}

      Look for:
      - Hot paths (most time spent)
      - Memory allocations
      - I/O operations
      - N+1 queries
      - Unnecessary computations

      Document findings.
    promise: "test -f PERF_PROFILE.txt"
    depends_on: [baseline]
    max_iterations: 3

  - id: optimize
    prompt: |
      Apply performance optimizations based on profiling.

      Goal: {{goal}}
      Target: {{target}}

      Common optimizations:
      - Add caching
      - Batch operations
      - Lazy loading
      - Algorithm improvements
      - Query optimization
      - Reduce allocations

      Keep tests passing!
    promise: "{{test_cmd}} && {{bench_cmd}}"
    depends_on: [profile]
    max_iterations: 10

  - id: verify
    prompt: |
      Verify performance improvement:
      - Compare against baseline
      - Ensure target is met: {{target}}
      - Clean up profiling artifacts
    promise: "{{bench_cmd}} && ! test -f PERF_BASELINE.txt && ! test -f PERF_PROFILE.txt"
    depends_on: [optimize]
    max_iterations: 3

on_complete:
  - "echo 'Performance optimization complete'"
  - "rm -f PERF_BASELINE.txt PERF_PROFILE.txt"

on_failure:
  - "echo 'Performance target not met - review manually'"
  - "rm -f PERF_BASELINE.txt PERF_PROFILE.txt"
