# Bugfix Loop Template
# Reproduce -> Fix -> Verify no regressions

name: bugfix
description: Bug fixing with regression prevention - reproduce, fix, verify

defaults:
  max_iterations: 10
  agent: auto

env:
  BUG: "{{bug_description}}"
  TEST_CMD: "{{test_cmd}}"
  FULL_TEST_CMD: "{{full_test_cmd}}"

loops:
  - id: reproduce
    prompt: |
      Write a test that reproduces this bug:
      {{bug_description}}

      The test should:
      - Fail with the current code
      - Demonstrate the exact bug behavior
      - Be specific and minimal
      - Include clear assertions
    promise: "{{test_cmd}} 2>&1 | grep -qE 'FAIL|failed|failing'"
    max_iterations: 3

  - id: fix
    prompt: |
      Fix the bug to make the test pass.

      Bug description: {{bug_description}}

      Guidelines:
      - Make the minimal change to fix the bug
      - Don't refactor unrelated code
      - Keep the fix focused
      - Add comments if the fix is non-obvious
    promise: "{{test_cmd}}"
    depends_on: [reproduce]
    max_iterations: 10

  - id: verify
    prompt: |
      Verify the fix doesn't break anything else.

      Run the full test suite and fix any regressions.
      The original bug fix must remain in place.
    promise: "{{full_test_cmd}}"
    depends_on: [fix]
    max_iterations: 3

on_complete:
  - "echo 'Bug fixed: {{bug_description}}'"

on_failure:
  - "echo 'Bugfix failed at: {{failed_loop}}'"
