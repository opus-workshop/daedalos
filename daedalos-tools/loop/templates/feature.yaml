# Feature Loop Template
# Full feature implementation with tests and documentation

name: feature
description: Complete feature implementation with tests

defaults:
  max_iterations: 15
  agent: auto

env:
  FEATURE: "{{feature}}"
  TEST_CMD: "{{test_cmd}}"
  BUILD_CMD: "{{build_cmd}}"

loops:
  - id: design
    prompt: |
      Design the implementation for:
      {{feature}}

      Create a brief design document or comments outlining:
      - Main components needed
      - Key interfaces/functions
      - Data structures
      - Integration points

      Don't implement yet - just plan.
    promise: "test -f DESIGN.md || git diff --name-only | grep -qE '\\.(md|txt)$'"
    max_iterations: 3

  - id: test-first
    prompt: |
      Write tests for the feature before implementation:
      {{feature}}

      Tests should:
      - Cover the happy path
      - Cover edge cases
      - Be runnable (may fail for now)
    promise: "{{test_cmd}} 2>&1 | grep -qE 'FAIL|failed|1 failed'"
    depends_on: [design]
    max_iterations: 5

  - id: implement
    prompt: |
      Implement the feature to make all tests pass:
      {{feature}}

      Guidelines:
      - Follow the design from earlier
      - Make tests pass one by one
      - Keep code clean as you go
    promise: "{{test_cmd}}"
    depends_on: [test-first]
    max_iterations: 15

  - id: build-verify
    prompt: |
      Ensure the feature builds correctly and integrates properly.
      Fix any build errors or warnings.
    promise: "{{build_cmd}}"
    depends_on: [implement]
    max_iterations: 5

on_complete:
  - "echo 'Feature implemented: {{feature}}'"
  - "rm -f DESIGN.md 2>/dev/null || true"

on_failure:
  - "echo 'Feature implementation failed at: {{failed_loop}}'"
