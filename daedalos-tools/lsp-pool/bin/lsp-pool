#!/usr/bin/env bash
# lsp-pool - Pre-warmed Language Server Pool for Daedalos
#
# Manages a pool of pre-started language servers for instant code intelligence.

set -euo pipefail

LSPPOOL_VERSION="1.0.0"
LSPPOOL_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/daedalos/lsp-pool"
LSPPOOL_DATA="${XDG_DATA_HOME:-$HOME/.local/share}/daedalos/lsp-pool"
LSPPOOL_SOCKET="${LSPPOOL_SOCKET:-/run/daedalos/lsp-pool.sock}"

# Get the real path, following symlinks
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
export PYTHONPATH="${PYTHONPATH:-}:$(dirname "$SCRIPT_DIR")"

mkdir -p "$LSPPOOL_CONFIG" "$LSPPOOL_DATA"

cmd_start() {
    echo "Starting LSP Pool daemon..."
    python3 -m lsppool.daemon start "$@"
}

cmd_stop() {
    python3 -m lsppool.daemon stop "$@"
}

cmd_status() {
    python3 -m lsppool.daemon status "$@"
}

cmd_warm() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool warm <language> [path]"
        exit 1
    fi
    local language="$1"
    local path="${2:-.}"
    python3 -m lsppool.servers warm --language "$language" --path "$path"
}

cmd_cool() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool cool <language>"
        exit 1
    fi
    local language="$1"
    python3 -m lsppool.servers cool --language "$language"
}

cmd_query() {
    if [[ $# -lt 2 ]]; then
        echo "Usage: lsp-pool query <command> <file> [--line N] [--col N]"
        exit 1
    fi
    python3 -m lsppool.query "$@"
}

cmd_list() {
    python3 -m lsppool.servers list "$@"
}

cmd_predict() {
    python3 -c "
from lsppool.predictor import Predictor
import json
p = Predictor()
preds = p.predict(5)
for pred in preds:
    print(f\"{pred['language']:12} {pred['confidence']*100:>5.1f}%  {pred['project']}\")
"
}

cmd_help() {
    cat << 'EOF'
lsp-pool - Pre-warmed Language Server Pool

USAGE:
  lsp-pool <command> [args]

COMMANDS:
  start [--foreground]       Start the pool daemon
  stop                       Stop the daemon
  status [--json]            Show daemon status

  warm <language> [path]     Pre-warm a server
  cool <language>            Stop servers for a language
  list [--json]              List running servers

  query <cmd> <file> [opts]  Send LSP query
    Commands: hover, definition, references, completion, diagnostics
    Options: --line N, --col N

  predict                    Show predicted servers to warm

EXAMPLES:
  lsp-pool start --foreground
  lsp-pool warm typescript /path/to/project
  lsp-pool query hover src/main.ts --line 42 --col 10
  lsp-pool status

PART OF DAEDALOS
  Tools designed BY AI, FOR AI development.
EOF
}

main() {
    case "${1:-help}" in
        start)      shift; cmd_start "$@" ;;
        stop)       shift; cmd_stop "$@" ;;
        status)     shift; cmd_status "$@" ;;
        warm)       shift; cmd_warm "$@" ;;
        cool)       shift; cmd_cool "$@" ;;
        query)      shift; cmd_query "$@" ;;
        list)       shift; cmd_list "$@" ;;
        predict)    shift; cmd_predict "$@" ;;
        version)    echo "lsp-pool $LSPPOOL_VERSION" ;;
        help|--help|-h) cmd_help ;;
        *)          echo "Unknown command: $1"; cmd_help; exit 1 ;;
    esac
}

main "$@"
