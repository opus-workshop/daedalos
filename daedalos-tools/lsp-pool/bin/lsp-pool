#!/usr/bin/env bash
# lsp-pool - Pre-warmed Language Server Pool for Daedalos
#
# Manages a pool of pre-started language servers for instant code intelligence.

set -euo pipefail

LSPPOOL_VERSION="1.0.0"
LSPPOOL_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/daedalos/lsp-pool"
LSPPOOL_DATA="${XDG_DATA_HOME:-$HOME/.local/share}/daedalos/lsp-pool"
LSPPOOL_SOCKET="${LSPPOOL_SOCKET:-/run/daedalos/lsp-pool.sock}"

# Get the real path, following symlinks
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
export PYTHONPATH="${PYTHONPATH:-}:$(dirname "$SCRIPT_DIR")"

mkdir -p "$LSPPOOL_CONFIG" "$LSPPOOL_DATA"

cmd_start() {
    echo "Starting LSP Pool daemon..."
    python3 -m lsppool.daemon start "$@"
}

cmd_stop() {
    python3 -m lsppool.daemon stop "$@"
}

cmd_status() {
    python3 -m lsppool.daemon status "$@"
}

cmd_warm() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool warm <language> [path]"
        exit 1
    fi
    local language="$1"
    local path="${2:-.}"
    python3 -m lsppool.servers warm --language "$language" --path "$path"
}

cmd_cool() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool cool <language>"
        exit 1
    fi
    local language="$1"
    python3 -m lsppool.servers cool --language "$language"
}

cmd_query() {
    if [[ $# -lt 2 ]]; then
        echo "Usage: lsp-pool query <command> <file> [--line N] [--col N]"
        exit 1
    fi
    python3 -m lsppool.query "$@"
}

cmd_list() {
    python3 -m lsppool.servers list "$@"
}

cmd_logs() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool logs <language>:<project>"
        exit 1
    fi
    local key="$1"
    python3 -c "
import asyncio
import json
from pathlib import Path
from lsppool.config import SOCKET_PATH

async def get_logs():
    try:
        reader, writer = await asyncio.open_unix_connection(str(SOCKET_PATH))
        request = {'type': 'logs', 'key': '$key'}
        writer.write(json.dumps(request).encode())
        await writer.drain()
        data = await reader.read(65536)
        response = json.loads(data.decode())
        writer.close()
        await writer.wait_closed()

        if response.get('success'):
            for line in response.get('logs', []):
                print(line)
        else:
            print(f\"Error: {response.get('error', 'Unknown')}\")
    except Exception as e:
        print(f'Could not connect to daemon: {e}')

asyncio.run(get_logs())
"
}

cmd_restart() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool restart <language>:<project>"
        exit 1
    fi
    local key="$1"
    python3 -c "
import asyncio
import json
from pathlib import Path
from lsppool.config import SOCKET_PATH

async def restart():
    try:
        reader, writer = await asyncio.open_unix_connection(str(SOCKET_PATH))
        request = {'type': 'restart', 'key': '$key'}
        writer.write(json.dumps(request).encode())
        await writer.drain()
        data = await reader.read(65536)
        response = json.loads(data.decode())
        writer.close()
        await writer.wait_closed()

        if response.get('success'):
            print(f'Server restarted: $key')
        else:
            print(f\"Error: {response.get('error', 'Failed to restart')}\")
    except Exception as e:
        print(f'Could not connect to daemon: {e}')

asyncio.run(restart())
"
}

cmd_predict() {
    python3 -c "
from lsppool.predictor import Predictor
import json
p = Predictor()
preds = p.predict(5)
for pred in preds:
    print(f\"{pred['language']:12} {pred['confidence']*100:>5.1f}%  {pred['project']}\")
"
}

cmd_languages() {
    python3 -c "
from lsppool.config import get_config
config = get_config()
servers = config.servers
print('Available language servers:')
print()
for lang, info in sorted(servers.items()):
    cmd = info.get('command', ['unknown'])[0]
    exts = ', '.join(info.get('extensions', []))
    mem = info.get('memory_estimate_mb', 300)
    print(f'  {lang:12} {cmd:30} {mem:>4}MB  {exts}')
"
}

cmd_detect() {
    if [[ $# -lt 1 ]]; then
        echo "Usage: lsp-pool detect <file>"
        exit 1
    fi
    python3 -c "
from lsppool.config import get_config
from pathlib import Path
import sys

file_path = Path('$1')
config = get_config()

ext = file_path.suffix.lower()
name = file_path.name

# Check each language server
for lang, info in config.servers.items():
    extensions = info.get('extensions', [])
    if ext in extensions or name in extensions:
        print(lang)
        sys.exit(0)

print('unknown')
sys.exit(1)
"
}

cmd_help() {
    cat << 'EOF'
lsp-pool - Pre-warmed Language Server Pool

USAGE:
  lsp-pool <command> [args]

DAEMON COMMANDS:
  start [--foreground]       Start the pool daemon
  stop                       Stop the daemon
  status [--json]            Show daemon status

SERVER MANAGEMENT:
  warm <language> [path]     Pre-warm a server
  cool <language>            Stop servers for a language
  list [--json]              List running servers
  logs <lang:project>        Show server stderr logs
  restart <lang:project>     Restart a server
  languages                  List supported languages

QUERIES:
  query <cmd> <file> [opts]  Send LSP query
    Commands: hover, definition, references, completion, diagnostics
    Options: --line N, --col N
  detect <file>              Detect language for file

INTELLIGENCE:
  predict                    Show predicted servers to warm

SUPPORTED LANGUAGES:
  typescript, python, rust, go, c, cpp, java, kotlin, swift,
  lua, ruby, elixir, zig, ocaml, haskell, bash, yaml, json,
  html, css, dockerfile, nix

EXAMPLES:
  lsp-pool start --foreground
  lsp-pool warm typescript /path/to/project
  lsp-pool query hover src/main.ts --line 42 --col 10
  lsp-pool languages
  lsp-pool detect src/main.py   # prints: python
  lsp-pool status

PART OF DAEDALOS
  Tools designed BY AI, FOR AI development.
EOF
}

main() {
    case "${1:-help}" in
        start)      shift; cmd_start "$@" ;;
        stop)       shift; cmd_stop "$@" ;;
        status)     shift; cmd_status "$@" ;;
        warm)       shift; cmd_warm "$@" ;;
        cool)       shift; cmd_cool "$@" ;;
        query)      shift; cmd_query "$@" ;;
        list)       shift; cmd_list "$@" ;;
        logs)       shift; cmd_logs "$@" ;;
        restart)    shift; cmd_restart "$@" ;;
        predict)    shift; cmd_predict "$@" ;;
        languages)  shift; cmd_languages "$@" ;;
        detect)     shift; cmd_detect "$@" ;;
        version)    echo "lsp-pool $LSPPOOL_VERSION" ;;
        help|--help|-h) cmd_help ;;
        *)          echo "Unknown command: $1"; cmd_help; exit 1 ;;
    esac
}

main "$@"
