#!/usr/bin/env bash
# review - Human code review workflow for Daedalos
#
# Structured code review with gates integration.

set -eo pipefail

REVIEW_VERSION="1.0.0"

DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/daedalos/review"
mkdir -p "$DATA_DIR"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' DIM='' NC=''
fi

log_error() { echo -e "${RED}error:${NC} $*" >&2; }
log_success() { echo -e "${GREEN}✓${NC} $*"; }
log_info() { echo -e "${BLUE}info:${NC} $*"; }

cmd_help() {
    cat << 'EOF'
review - Human code review workflow for Daedalos

USAGE:
    review <command> [args...]

COMMANDS:
    request [REF]    Request review for changes (default: staged/HEAD)
    start [ID]       Start reviewing a request
    approve [ID]     Approve changes
    reject [ID]      Reject with comments
    comment [ID]     Add comment without decision
    list             List pending reviews
    show [ID]        Show review details

OPTIONS:
    --message, -m    Review message/comment
    --files          Limit to specific files
    --diff           Show diff during review

REVIEW FLOW:
    1. AI makes changes
    2. AI runs: review request "implemented feature X"
    3. Human runs: review start
    4. Human reviews changes
    5. Human runs: review approve/reject

EXAMPLES:
    review request                   # Request review for staged changes
    review request HEAD~3..HEAD      # Request review for recent commits
    review list                      # See pending reviews
    review start                     # Start reviewing
    review approve -m "LGTM"         # Approve with comment
    review reject -m "needs tests"   # Reject with feedback

INTEGRATION:
    - gates: Requires review for certain actions when level=collaborative
    - journal: Logs all review activity
    - notify: Notifies when review requested/completed

EOF
}

# Generate review ID
generate_id() {
    echo "review-$(date +%Y%m%d%H%M%S)-$(head -c 4 /dev/urandom | xxd -p)"
}

cmd_request() {
    local ref="${1:-}"
    local message=""

    shift || true

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--message) message="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    if ! git rev-parse --git-dir &>/dev/null; then
        log_error "Not in a git repository"
        exit 1
    fi

    local review_id=$(generate_id)
    local review_file="$DATA_DIR/$review_id.json"

    # Determine what to review
    local diff_ref=""
    local diff_stat=""
    local file_count=0

    if [[ -z "$ref" ]]; then
        # Check for staged changes first
        if git diff --cached --quiet 2>/dev/null; then
            # No staged changes, use HEAD
            diff_ref="HEAD^..HEAD"
        else
            diff_ref="--cached"
        fi
    else
        diff_ref="$ref"
    fi

    # Get stats
    if [[ "$diff_ref" == "--cached" ]]; then
        diff_stat=$(git diff --cached --stat 2>/dev/null | tail -1)
        file_count=$(git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' ')
    else
        diff_stat=$(git diff "$diff_ref" --stat 2>/dev/null | tail -1)
        file_count=$(git diff "$diff_ref" --name-only 2>/dev/null | wc -l | tr -d ' ')
    fi

    if [[ "$file_count" -eq 0 ]]; then
        log_error "No changes to review"
        exit 1
    fi

    # Save review request
    cat > "$review_file" << EOF
{
    "id": "$review_id",
    "status": "pending",
    "ref": "$diff_ref",
    "message": "$message",
    "requested_by": "$USER",
    "requested_at": $(date +%s),
    "project": "$PWD",
    "branch": "$(git branch --show-current)",
    "file_count": $file_count,
    "stats": "$diff_stat"
}
EOF

    log_success "Review requested: $review_id"
    echo ""
    echo -e "${BOLD}Review Request${NC}"
    echo -e "  ${CYAN}ID:${NC}      $review_id"
    echo -e "  ${CYAN}Changes:${NC} $file_count files"
    echo -e "  ${CYAN}Stats:${NC}   $diff_stat"
    [[ -n "$message" ]] && echo -e "  ${CYAN}Message:${NC} $message"
    echo ""
    echo "Reviewer: run 'review start' to begin review"

    # Notify
    if command -v notify &>/dev/null; then
        notify "Review requested" --title "Code Review" 2>/dev/null &
    fi

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Review requested: $review_id ($file_count files)" "review" "review_request" 2>/dev/null || true
    fi
}

cmd_list() {
    local status_filter=""
    local as_json=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --pending) status_filter="pending"; shift ;;
            --approved) status_filter="approved"; shift ;;
            --rejected) status_filter="rejected"; shift ;;
            --json) as_json=true; shift ;;
            *) shift ;;
        esac
    done

    if [[ ! -d "$DATA_DIR" ]] || [[ -z "$(ls -A "$DATA_DIR"/*.json 2>/dev/null)" ]]; then
        echo "No review requests"
        return
    fi

    if [[ "$as_json" == "true" ]]; then
        echo "["
        local first=true
        for file in "$DATA_DIR"/*.json; do
            [[ "$first" == "true" ]] || echo ","
            first=false
            cat "$file"
        done
        echo "]"
        return
    fi

    echo -e "${BOLD}Review Requests${NC}"
    echo ""

    for file in $(ls -t "$DATA_DIR"/*.json 2>/dev/null); do
        local id=$(grep '"id"' "$file" | cut -d'"' -f4)
        local status=$(grep '"status"' "$file" | cut -d'"' -f4)
        local message=$(grep '"message"' "$file" | cut -d'"' -f4)
        local file_count=$(grep '"file_count"' "$file" | grep -o '[0-9]*')
        local requested_by=$(grep '"requested_by"' "$file" | cut -d'"' -f4)

        # Filter by status
        if [[ -n "$status_filter" ]] && [[ "$status" != "$status_filter" ]]; then
            continue
        fi

        # Status indicator
        local status_icon=""
        case "$status" in
            pending) status_icon="${YELLOW}○${NC}" ;;
            approved) status_icon="${GREEN}✓${NC}" ;;
            rejected) status_icon="${RED}✗${NC}" ;;
            *) status_icon="${DIM}?${NC}" ;;
        esac

        echo -e "  $status_icon ${CYAN}$id${NC}"
        echo -e "    Status: $status | Files: $file_count | By: $requested_by"
        [[ -n "$message" ]] && echo -e "    ${DIM}$message${NC}"
        echo ""
    done
}

cmd_start() {
    local review_id="$1"

    # Find pending review
    if [[ -z "$review_id" ]]; then
        review_id=$(ls -t "$DATA_DIR"/*.json 2>/dev/null | head -1 | xargs -I{} grep '"id"' {} | cut -d'"' -f4)
    fi

    if [[ -z "$review_id" ]]; then
        log_error "No reviews to start"
        exit 1
    fi

    local review_file="$DATA_DIR/$review_id.json"

    if [[ ! -f "$review_file" ]]; then
        log_error "Review not found: $review_id"
        exit 1
    fi

    local ref=$(grep '"ref"' "$review_file" | cut -d'"' -f4)
    local project=$(grep '"project"' "$review_file" | cut -d'"' -f4)
    local message=$(grep '"message"' "$review_file" | cut -d'"' -f4)

    echo -e "${BOLD}Starting Review: $review_id${NC}"
    [[ -n "$message" ]] && echo -e "${DIM}$message${NC}"
    echo ""

    # Show diff
    if [[ "$ref" == "--cached" ]]; then
        git diff --cached --stat
        echo ""
        echo "Press Enter to see full diff, or 'q' to skip"
        read -n 1 -r
        [[ ! $REPLY =~ ^[Qq]$ ]] && git diff --cached
    else
        git diff "$ref" --stat
        echo ""
        echo "Press Enter to see full diff, or 'q' to skip"
        read -n 1 -r
        [[ ! $REPLY =~ ^[Qq]$ ]] && git diff "$ref"
    fi

    echo ""
    echo -e "${BOLD}Review Actions:${NC}"
    echo "  review approve -m 'comment'   # Approve"
    echo "  review reject -m 'comment'    # Reject"
    echo "  review comment -m 'comment'   # Comment only"

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Started review: $review_id" "review" "review_start" 2>/dev/null || true
    fi
}

cmd_approve() {
    local review_id="$1"
    local message=""

    shift || true

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--message) message="$2"; shift 2 ;;
            *) review_id="$1"; shift ;;
        esac
    done

    # Find review
    if [[ -z "$review_id" ]]; then
        review_id=$(ls -t "$DATA_DIR"/*.json 2>/dev/null | head -1 | xargs -I{} grep '"id"' {} | cut -d'"' -f4)
    fi

    local review_file="$DATA_DIR/$review_id.json"

    if [[ ! -f "$review_file" ]]; then
        log_error "Review not found: $review_id"
        exit 1
    fi

    # Update status using a temp file (for portability)
    local temp_file=$(mktemp)
    sed 's/"status": "[^"]*"/"status": "approved"/' "$review_file" > "$temp_file"
    mv "$temp_file" "$review_file"

    # Add approval info
    echo "{\"approved_by\": \"$USER\", \"approved_at\": $(date +%s), \"comment\": \"$message\"}" >> "$review_file.approval"

    log_success "Review approved: $review_id"
    [[ -n "$message" ]] && echo "Comment: $message"

    # Notify
    if command -v notify &>/dev/null; then
        notify success "Review approved" 2>/dev/null &
    fi

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Approved review: $review_id" "review" "review_approve" 2>/dev/null || true
    fi
}

cmd_reject() {
    local review_id="$1"
    local message=""

    shift || true

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--message) message="$2"; shift 2 ;;
            *) review_id="$1"; shift ;;
        esac
    done

    if [[ -z "$message" ]]; then
        log_error "Rejection requires a message (-m)"
        exit 1
    fi

    # Find review
    if [[ -z "$review_id" ]]; then
        review_id=$(ls -t "$DATA_DIR"/*.json 2>/dev/null | head -1 | xargs -I{} grep '"id"' {} | cut -d'"' -f4)
    fi

    local review_file="$DATA_DIR/$review_id.json"

    if [[ ! -f "$review_file" ]]; then
        log_error "Review not found: $review_id"
        exit 1
    fi

    # Update status
    local temp_file=$(mktemp)
    sed 's/"status": "[^"]*"/"status": "rejected"/' "$review_file" > "$temp_file"
    mv "$temp_file" "$review_file"

    # Add rejection info
    echo "{\"rejected_by\": \"$USER\", \"rejected_at\": $(date +%s), \"comment\": \"$message\"}" >> "$review_file.rejection"

    log_error "Review rejected: $review_id"
    echo "Reason: $message"

    # Notify
    if command -v notify &>/dev/null; then
        notify error "Review rejected: $message" 2>/dev/null &
    fi

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Rejected review: $review_id - $message" "review" "review_reject" 2>/dev/null || true
    fi
}

cmd_comment() {
    local review_id="$1"
    local message=""

    shift || true

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -m|--message) message="$2"; shift 2 ;;
            *) review_id="$1"; shift ;;
        esac
    done

    if [[ -z "$message" ]]; then
        log_error "Comment required (-m)"
        exit 1
    fi

    # Find review
    if [[ -z "$review_id" ]]; then
        review_id=$(ls -t "$DATA_DIR"/*.json 2>/dev/null | head -1 | xargs -I{} grep '"id"' {} | cut -d'"' -f4)
    fi

    local review_file="$DATA_DIR/$review_id.json"

    if [[ ! -f "$review_file" ]]; then
        log_error "Review not found: $review_id"
        exit 1
    fi

    # Add comment
    echo "{\"by\": \"$USER\", \"at\": $(date +%s), \"comment\": \"$message\"}" >> "$review_file.comments"

    log_success "Comment added to: $review_id"

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Commented on review: $review_id" "review" "review_comment" 2>/dev/null || true
    fi
}

cmd_show() {
    local review_id="$1"

    if [[ -z "$review_id" ]]; then
        log_error "Review ID required"
        exit 1
    fi

    local review_file="$DATA_DIR/$review_id.json"

    if [[ ! -f "$review_file" ]]; then
        log_error "Review not found: $review_id"
        exit 1
    fi

    cat "$review_file" | python3 -m json.tool 2>/dev/null || cat "$review_file"

    # Show comments
    if [[ -f "$review_file.comments" ]]; then
        echo ""
        echo "Comments:"
        cat "$review_file.comments"
    fi
}

main() {
    local cmd="${1:-help}"

    case "$cmd" in
        help|--help|-h)
            cmd_help
            ;;
        request|req|r)
            shift
            cmd_request "$@"
            ;;
        start|begin)
            shift
            cmd_start "$@"
            ;;
        approve|lgtm|ok)
            shift
            cmd_approve "$@"
            ;;
        reject|deny)
            shift
            cmd_reject "$@"
            ;;
        comment|c)
            shift
            cmd_comment "$@"
            ;;
        list|ls)
            shift
            cmd_list "$@"
            ;;
        show)
            shift
            cmd_show "$@"
            ;;
        version|--version|-V)
            echo "review $REVIEW_VERSION"
            ;;
        *)
            log_error "Unknown command: $cmd"
            echo "Run 'review help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
