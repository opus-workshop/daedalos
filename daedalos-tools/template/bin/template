#!/usr/bin/env bash
# template - Project scaffolding for Daedalos
#
# Create new projects from templates.

set -eo pipefail

TEMPLATE_VERSION="1.0.0"

# Resolve symlinks to find real script location
SCRIPT_PATH="$0"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/daedalos/template"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/daedalos"
TEMPLATE_DIR="$DATA_DIR/templates"
BUILTIN_DIR="${DAEDALOS_TEMPLATE_DIR:-$(dirname "$SCRIPT_DIR")/templates}"

mkdir -p "$TEMPLATE_DIR"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' DIM='' NC=''
fi

log_error() { echo -e "${RED}error:${NC} $*" >&2; }
log_success() { echo -e "${GREEN}âœ“${NC} $*"; }
log_info() { echo -e "${BLUE}info:${NC} $*"; }

cmd_help() {
    cat << 'EOF'
template - Project scaffolding for Daedalos

USAGE:
    template <command> [args...]

COMMANDS:
    new <TEMPLATE> <NAME>   Create new project from template
    list                    List available templates
    show <TEMPLATE>         Show template details
    add <PATH>              Add directory as template
    remove <TEMPLATE>       Remove a user template
    init                    Initialize template in current dir
    vars <TEMPLATE>         Show template variables

BUILT-IN TEMPLATES:
    bash-tool       Bash CLI tool with standard structure
    python-cli      Python CLI with Click
    node-api        Node.js REST API
    rust-cli        Rust CLI with clap
    go-service      Go microservice
    daedalos-tool   Daedalos tool structure

TEMPLATE VARIABLES:
    Templates can include placeholders:
    {{NAME}}        Project name
    {{AUTHOR}}      Author name (from git config)
    {{EMAIL}}       Author email (from git config)
    {{DATE}}        Current date
    {{YEAR}}        Current year
    {{DESCRIPTION}} Project description

OPTIONS:
    --var KEY=VALUE     Set template variable
    --no-git            Don't initialize git
    --force             Overwrite existing directory

EXAMPLES:
    template new bash-tool my-tool          # Create bash tool
    template new python-cli myapp           # Create Python CLI
    template new bash-tool cli --var DESC="My CLI tool"
    template add ~/my-template              # Save as template
    template list                           # Show all templates

CREATING TEMPLATES:
    1. Create a project structure
    2. Use {{PLACEHOLDERS}} for variable content
    3. Add template.json for metadata
    4. Run: template add /path/to/template

EOF
}

# Get all template directories
get_template_dirs() {
    # Built-in templates first, then user templates
    echo "$BUILTIN_DIR"
    echo "$TEMPLATE_DIR"
}

# Find a template by name
find_template() {
    local name="$1"

    # Check user templates first
    if [[ -d "$TEMPLATE_DIR/$name" ]]; then
        echo "$TEMPLATE_DIR/$name"
        return
    fi

    # Check built-in templates
    if [[ -d "$BUILTIN_DIR/$name" ]]; then
        echo "$BUILTIN_DIR/$name"
        return
    fi

    return 1
}

# Replace template variables in a string
replace_vars() {
    local content="$1"
    shift
    local vars=("$@")

    # Default variables
    local name="${PROJECT_NAME:-project}"
    local author=$(git config user.name 2>/dev/null || echo "$USER")
    local email=$(git config user.email 2>/dev/null || echo "$USER@localhost")
    local date=$(date +%Y-%m-%d)
    local year=$(date +%Y)
    local description="${PROJECT_DESC:-A new project}"

    content="${content//\{\{NAME\}\}/$name}"
    content="${content//\{\{AUTHOR\}\}/$author}"
    content="${content//\{\{EMAIL\}\}/$email}"
    content="${content//\{\{DATE\}\}/$date}"
    content="${content//\{\{YEAR\}\}/$year}"
    content="${content//\{\{DESCRIPTION\}\}/$description}"

    # Custom variables
    for var in "${vars[@]}"; do
        local key="${var%%=*}"
        local value="${var#*=}"
        content="${content//\{\{$key\}\}/$value}"
    done

    echo "$content"
}

# Process a template file
process_file() {
    local src="$1"
    local dst="$2"
    shift 2
    local vars=("$@")

    # Replace variables in filename
    local dst_name=$(replace_vars "$(basename "$dst")" "${vars[@]}")
    dst="$(dirname "$dst")/$dst_name"

    # Skip template metadata
    [[ "$(basename "$src")" == "template.json" ]] && return

    if [[ -d "$src" ]]; then
        mkdir -p "$dst"
        return
    fi

    # Check if binary file
    if file "$src" 2>/dev/null | grep -q "binary\|executable"; then
        cp "$src" "$dst"
        return
    fi

    # Text file - replace variables
    local content=$(cat "$src")
    content=$(replace_vars "$content" "${vars[@]}")
    echo "$content" > "$dst"

    # Preserve permissions
    chmod --reference="$src" "$dst" 2>/dev/null || chmod $(stat -f %Lp "$src" 2>/dev/null || echo 644) "$dst"
}

cmd_new() {
    local template_name=""
    local project_name=""
    local no_git=false
    local force=false
    local custom_vars=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --var) custom_vars+=("$2"); shift 2 ;;
            --no-git) no_git=true; shift ;;
            --force) force=true; shift ;;
            -*)
                log_error "Unknown option: $1"
                exit 1
                ;;
            *)
                if [[ -z "$template_name" ]]; then
                    template_name="$1"
                elif [[ -z "$project_name" ]]; then
                    project_name="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$template_name" ]] || [[ -z "$project_name" ]]; then
        log_error "Template and project name required"
        echo "Usage: template new <TEMPLATE> <NAME>"
        echo "Run 'template list' to see available templates"
        exit 1
    fi

    # Find template
    local template_path=$(find_template "$template_name")
    if [[ -z "$template_path" ]] || [[ ! -d "$template_path" ]]; then
        log_error "Template not found: $template_name"
        echo "Run 'template list' to see available templates"
        exit 1
    fi

    # Check destination
    if [[ -e "$project_name" ]] && [[ "$force" != "true" ]]; then
        log_error "Directory already exists: $project_name"
        echo "Use --force to overwrite"
        exit 1
    fi

    # Export for replace_vars
    export PROJECT_NAME="$project_name"

    # Extract description from custom vars
    for var in "${custom_vars[@]}"; do
        if [[ "$var" == DESC=* ]] || [[ "$var" == DESCRIPTION=* ]]; then
            export PROJECT_DESC="${var#*=}"
        fi
    done

    # Create project directory
    mkdir -p "$project_name"

    log_info "Creating project from template: $template_name"

    # Copy and process files
    find "$template_path" -type f -o -type d | while read -r src; do
        local rel="${src#$template_path/}"
        [[ "$rel" == "$template_path" ]] && continue
        [[ -z "$rel" ]] && continue

        local dst="$project_name/$rel"

        # Replace {{NAME}} in path
        dst=$(replace_vars "$dst" "${custom_vars[@]}")

        process_file "$src" "$dst" "${custom_vars[@]}"
    done

    # Initialize git
    if [[ "$no_git" != "true" ]]; then
        (
            cd "$project_name"
            git init -q 2>/dev/null || true
            git add . 2>/dev/null || true
        )
    fi

    log_success "Project created: $project_name"
    echo ""
    echo "Next steps:"
    echo "  cd $project_name"

    # Show template-specific instructions
    if [[ -f "$template_path/template.json" ]]; then
        local next_steps=$(grep -o '"next_steps": \[[^]]*\]' "$template_path/template.json" 2>/dev/null | sed 's/"next_steps": \[//;s/\]//;s/"//g;s/,/\n/g')
        if [[ -n "$next_steps" ]]; then
            echo "$next_steps" | while read -r step; do
                [[ -n "$step" ]] && echo "  $step"
            done
        fi
    fi

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Created project '$project_name' from template '$template_name'" "template" "project_create" 2>/dev/null || true
    fi
}

cmd_list() {
    echo -e "${BOLD}Available Templates${NC}"
    echo ""

    # Built-in templates
    if [[ -d "$BUILTIN_DIR" ]] && [[ -n "$(ls -A "$BUILTIN_DIR" 2>/dev/null)" ]]; then
        echo -e "${CYAN}Built-in:${NC}"
        for dir in "$BUILTIN_DIR"/*/; do
            [[ -d "$dir" ]] || continue
            local name=$(basename "$dir")
            local desc=""

            if [[ -f "$dir/template.json" ]]; then
                desc=$(grep -o '"description": "[^"]*"' "$dir/template.json" 2>/dev/null | cut -d'"' -f4)
            fi

            echo -e "  ${GREEN}$name${NC}"
            [[ -n "$desc" ]] && echo -e "    ${DIM}$desc${NC}"
        done
        echo ""
    fi

    # User templates
    if [[ -d "$TEMPLATE_DIR" ]] && [[ -n "$(ls -A "$TEMPLATE_DIR" 2>/dev/null)" ]]; then
        echo -e "${CYAN}User Templates:${NC}"
        for dir in "$TEMPLATE_DIR"/*/; do
            [[ -d "$dir" ]] || continue
            local name=$(basename "$dir")
            local desc=""

            if [[ -f "$dir/template.json" ]]; then
                desc=$(grep -o '"description": "[^"]*"' "$dir/template.json" 2>/dev/null | cut -d'"' -f4)
            fi

            echo -e "  ${GREEN}$name${NC}"
            [[ -n "$desc" ]] && echo -e "    ${DIM}$desc${NC}"
        done
    else
        echo -e "${DIM}No user templates. Add one with: template add /path/to/template${NC}"
    fi
}

cmd_show() {
    local name="$1"

    if [[ -z "$name" ]]; then
        log_error "Template name required"
        exit 1
    fi

    local template_path=$(find_template "$name")
    if [[ -z "$template_path" ]]; then
        log_error "Template not found: $name"
        exit 1
    fi

    echo -e "${BOLD}Template: $name${NC}"
    echo -e "${DIM}Path: $template_path${NC}"
    echo ""

    # Show metadata
    if [[ -f "$template_path/template.json" ]]; then
        echo -e "${CYAN}Metadata:${NC}"
        cat "$template_path/template.json" | python3 -m json.tool 2>/dev/null || cat "$template_path/template.json"
        echo ""
    fi

    # Show structure
    echo -e "${CYAN}Structure:${NC}"
    if command -v tree &>/dev/null; then
        tree -L 3 --noreport "$template_path" | tail -n +2
    else
        find "$template_path" -maxdepth 3 -print | sed "s|$template_path|.|" | sort
    fi
}

cmd_add() {
    local src="$1"
    local name="$2"

    if [[ -z "$src" ]]; then
        log_error "Source path required"
        echo "Usage: template add /path/to/template [name]"
        exit 1
    fi

    if [[ ! -d "$src" ]]; then
        log_error "Not a directory: $src"
        exit 1
    fi

    # Use directory name if no name provided
    name="${name:-$(basename "$src")}"

    local dst="$TEMPLATE_DIR/$name"

    if [[ -d "$dst" ]]; then
        log_error "Template already exists: $name"
        echo "Use 'template remove $name' first"
        exit 1
    fi

    # Copy template
    cp -r "$src" "$dst"

    # Create metadata if missing
    if [[ ! -f "$dst/template.json" ]]; then
        cat > "$dst/template.json" << EOF
{
    "name": "$name",
    "description": "User template",
    "version": "1.0.0",
    "author": "$(git config user.name 2>/dev/null || echo "$USER")"
}
EOF
    fi

    log_success "Template added: $name"
}

cmd_remove() {
    local name="$1"

    if [[ -z "$name" ]]; then
        log_error "Template name required"
        exit 1
    fi

    local template_path="$TEMPLATE_DIR/$name"

    if [[ ! -d "$template_path" ]]; then
        log_error "User template not found: $name"
        exit 1
    fi

    rm -rf "$template_path"
    log_success "Template removed: $name"
}

cmd_vars() {
    local name="$1"

    if [[ -z "$name" ]]; then
        log_error "Template name required"
        exit 1
    fi

    local template_path=$(find_template "$name")
    if [[ -z "$template_path" ]]; then
        log_error "Template not found: $name"
        exit 1
    fi

    echo -e "${BOLD}Template Variables: $name${NC}"
    echo ""

    echo -e "${CYAN}Standard Variables:${NC}"
    echo "  {{NAME}}        - Project name"
    echo "  {{AUTHOR}}      - Git user.name or \$USER"
    echo "  {{EMAIL}}       - Git user.email"
    echo "  {{DATE}}        - Current date (YYYY-MM-DD)"
    echo "  {{YEAR}}        - Current year"
    echo "  {{DESCRIPTION}} - Project description"
    echo ""

    # Find custom variables in template
    echo -e "${CYAN}Variables Used in Template:${NC}"
    grep -roh '{{[A-Z_]*}}' "$template_path" 2>/dev/null | sort -u | while read -r var; do
        echo "  $var"
    done
}

cmd_init() {
    local name="${1:-$(basename "$PWD")}"

    # Create template.json in current directory
    cat > template.json << EOF
{
    "name": "$name",
    "description": "{{DESCRIPTION}}",
    "version": "1.0.0",
    "author": "$(git config user.name 2>/dev/null || echo "$USER")",
    "variables": [
        "NAME",
        "DESCRIPTION"
    ],
    "next_steps": [
        "Review the generated files",
        "Run the setup script"
    ]
}
EOF

    log_success "Template initialized: template.json"
    echo "Edit template.json and use {{PLACEHOLDERS}} in your files"
    echo "Then run: template add . $name"
}

main() {
    local cmd="${1:-help}"

    case "$cmd" in
        help|--help|-h)
            cmd_help
            ;;
        new|create|n)
            shift
            cmd_new "$@"
            ;;
        list|ls|l)
            cmd_list
            ;;
        show|info)
            shift
            cmd_show "$@"
            ;;
        add|save)
            shift
            cmd_add "$@"
            ;;
        remove|rm|delete)
            shift
            cmd_remove "$@"
            ;;
        vars|variables)
            shift
            cmd_vars "$@"
            ;;
        init)
            shift
            cmd_init "$@"
            ;;
        version|--version|-V)
            echo "template $TEMPLATE_VERSION"
            ;;
        *)
            log_error "Unknown command: $cmd"
            echo "Run 'template help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
