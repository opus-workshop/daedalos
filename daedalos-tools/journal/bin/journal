#!/usr/bin/env bash
# journal - Narrative reconstruction for Daedalos
#
# Answer "what happened?" with a coherent timeline.

set -eo pipefail

JOURNAL_VERSION="1.0.0"

# Get the real path, following symlinks
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

export PYTHONPATH="${PYTHONPATH:-}:$LIB_DIR"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' DIM='' NC=''
fi

log_error() { echo -e "${RED}error:${NC} $*" >&2; }

cmd_help() {
    cat << 'EOF'
journal - Narrative reconstruction for Daedalos

USAGE:
    journal [command] [options]

COMMANDS:
    what             What happened? (default command)
    events           List raw events
    summary          Show event summary
    log              Log a custom event

OPTIONS:
    --hours, -h N    Hours to look back (default: 1)
    --days N         Days to look back
    --source S       Filter by source (gates, loop, agent, undo, mcp-hub)
    --type T         Filter by event type
    --verbose, -v    Show more details
    --json           Output as JSON
    --limit N        Maximum events (default: 100)

EXAMPLES:
    journal                      # What happened in the last hour?
    journal what -h 8            # What happened in the last 8 hours?
    journal what --days 1        # What happened today?
    journal events --source loop # All loop events
    journal summary              # Quick summary stats
    journal log "Started deploy" # Log a custom event

SOURCES:
    gates        Gate checks and approvals
    loop         Iteration loop events
    agent        Agent lifecycle events
    undo         File changes and checkpoints
    mcp-hub      MCP server events

PHILOSOPHY:
    "What happened?" is the most important debugging question.
    The journal aggregates events from all Daedalos tools to
    build a coherent narrative of AI agent activity.

EOF
}

cmd_what() {
    local hours=1
    local verbose=false
    local source=""
    local as_json=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--hours) hours="$2"; shift 2 ;;
            --days) hours=$((${2} * 24)); shift 2 ;;
            --source) source="$2"; shift 2 ;;
            -v|--verbose) verbose=true; shift ;;
            --json) as_json=true; shift ;;
            *) shift ;;
        esac
    done

    python3 << PYTHON
import sys
import json
sys.path.insert(0, "$LIB_DIR")

from narrative import what_happened, build_summary
from collector import collect_all_events

hours = $hours
verbose = $([[ "$verbose" == true ]] && echo "True" || echo "False")
source = "$source" if "$source" else None
sources = [source] if source else None
as_json = $([[ "$as_json" == true ]] && echo "True" || echo "False")

if as_json:
    events = collect_all_events(hours=hours, sources=sources)
    from narrative import build_summary
    result = {
        "events": [e.to_dict() for e in events],
        "summary": build_summary(events),
    }
    print(json.dumps(result, indent=2))
else:
    print(what_happened(hours=hours, sources=sources, verbose=verbose))
PYTHON
}

cmd_events() {
    local hours=24
    local source=""
    local event_type=""
    local limit=100
    local as_json=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--hours) hours="$2"; shift 2 ;;
            --days) hours=$((${2} * 24)); shift 2 ;;
            --source) source="$2"; shift 2 ;;
            --type) event_type="$2"; shift 2 ;;
            --limit) limit="$2"; shift 2 ;;
            --json) as_json=true; shift ;;
            *) shift ;;
        esac
    done

    python3 << PYTHON
import sys
import json
from datetime import datetime
sys.path.insert(0, "$LIB_DIR")

from collector import collect_all_events

hours = $hours
source = "$source" if "$source" else None
event_type = "$event_type" if "$event_type" else None
limit = $limit
as_json = $([[ "$as_json" == true ]] && echo "True" || echo "False")

sources = [source] if source else None
types = [event_type] if event_type else None

events = collect_all_events(hours=hours, sources=sources, event_types=types, limit=limit)

if as_json:
    print(json.dumps([e.to_dict() for e in events], indent=2))
else:
    for event in events:
        dt = datetime.fromtimestamp(event.timestamp)
        time_str = dt.strftime("%Y-%m-%d %H:%M:%S")
        print(f"{time_str}  [{event.source}] {event.event_type}: {event.summary}")
PYTHON
}

cmd_summary() {
    local hours=24
    local as_json=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--hours) hours="$2"; shift 2 ;;
            --days) hours=$((${2} * 24)); shift 2 ;;
            --json) as_json=true; shift ;;
            *) shift ;;
        esac
    done

    python3 << PYTHON
import sys
import json
sys.path.insert(0, "$LIB_DIR")

from collector import collect_all_events
from narrative import build_summary

hours = $hours
as_json = $([[ "$as_json" == true ]] && echo "True" || echo "False")

events = collect_all_events(hours=hours)
summary = build_summary(events)

if as_json:
    print(json.dumps(summary, indent=2))
else:
    print(f"Total events: {summary['total_events']}")
    print(f"Time range: {summary['time_range']['start']} - {summary['time_range']['end']}")
    print()

    if summary['highlights']:
        print("Highlights:")
        for h in summary['highlights']:
            print(f"  â€¢ {h}")
        print()

    if summary['by_source']:
        print("By source:")
        for source, count in sorted(summary['by_source'].items(), key=lambda x: -x[1]):
            print(f"  {source}: {count}")
        print()

    if summary['by_type']:
        print("By event type:")
        for etype, count in sorted(summary['by_type'].items(), key=lambda x: -x[1]):
            print(f"  {etype}: {count}")
PYTHON
}

cmd_log() {
    local summary="$1"
    local source="${2:-user}"
    local event_type="${3:-custom}"

    if [[ -z "$summary" ]]; then
        log_error "Summary message required"
        echo "Usage: journal log <message> [source] [event_type]"
        exit 1
    fi

    python3 << PYTHON
import sys
sys.path.insert(0, "$LIB_DIR")

from collector import log_event

log_event(
    source="$source",
    event_type="$event_type",
    summary="""$summary""",
)
print("Event logged")
PYTHON
}

main() {
    local cmd="${1:-what}"

    case "$cmd" in
        help|--help|-h)
            cmd_help
            ;;
        what)
            shift || true
            cmd_what "$@"
            ;;
        events)
            shift
            cmd_events "$@"
            ;;
        summary)
            shift
            cmd_summary "$@"
            ;;
        log)
            shift
            cmd_log "$@"
            ;;
        version|--version|-V)
            echo "journal $JOURNAL_VERSION"
            ;;
        *)
            # Default: treat as "what" command with args
            cmd_what "$@"
            ;;
    esac
}

main "$@"
