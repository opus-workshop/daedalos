#!/usr/bin/env bash
# pair - Pair programming mode for Daedalos
#
# Share your terminal session with another human or AI.

set -eo pipefail

PAIR_VERSION="1.0.0"

DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/daedalos/pair"
mkdir -p "$DATA_DIR"

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    DIM='\033[2m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' DIM='' NC=''
fi

log_error() { echo -e "${RED}error:${NC} $*" >&2; }
log_success() { echo -e "${GREEN}âœ“${NC} $*"; }
log_info() { echo -e "${BLUE}info:${NC} $*"; }

cmd_help() {
    cat << 'EOF'
pair - Pair programming mode for Daedalos

USAGE:
    pair <command> [args...]

COMMANDS:
    start [NAME]     Start a pair session (creates tmux session)
    join <NAME>      Join an existing pair session
    leave            Leave current pair session
    list             List active pair sessions
    invite           Generate invite link/command
    end              End pair session (kicks all participants)

MODES:
    --driver         You control, partner watches
    --navigator      Partner controls, you watch
    --equal          Both can control (default)

OPTIONS:
    --readonly       Join in read-only mode
    --name NAME      Session name
    --project PATH   Project directory to pair on

EXAMPLES:
    pair start                      # Start session in current dir
    pair start feature-work         # Named session
    pair join feature-work          # Join existing session
    pair invite                     # Get command for partner
    pair list                       # Show active sessions

SHARING OPTIONS:
    Local (same machine):
        Partner runs: pair join <session-name>

    Remote (SSH):
        Partner runs: ssh user@host -t "pair join <session-name>"

    Tmate (public):
        pair start --tmate          # Uses tmate for public sharing

INTEGRATION:
    - env: Pair session inherits project environment
    - journal: Logs pair session activity
    - notify: Notifies when partner joins/leaves

EOF
}

# Generate session name
generate_name() {
    local adjectives=("swift" "bright" "calm" "eager" "fair" "glad" "keen" "neat" "wise" "bold")
    local nouns=("fox" "owl" "bee" "elk" "jay" "ant" "bat" "cod" "emu" "gnu")

    local adj=${adjectives[$RANDOM % ${#adjectives[@]}]}
    local noun=${nouns[$RANDOM % ${#nouns[@]}]}
    local num=$((RANDOM % 100))

    echo "${adj}-${noun}-${num}"
}

# Check if tmux is available
check_tmux() {
    if ! command -v tmux &>/dev/null; then
        log_error "tmux is required for pair programming"
        echo "Install with: brew install tmux / apt install tmux"
        exit 1
    fi
}

# Get socket path for pair sessions
get_socket_path() {
    echo "$DATA_DIR/sockets"
}

cmd_start() {
    check_tmux

    local session_name=""
    local project_dir="$PWD"
    local mode="equal"
    local use_tmate=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --driver) mode="driver"; shift ;;
            --navigator) mode="navigator"; shift ;;
            --equal) mode="equal"; shift ;;
            --project) project_dir="$2"; shift 2 ;;
            --tmate) use_tmate=true; shift ;;
            -*) shift ;;
            *) session_name="$1"; shift ;;
        esac
    done

    session_name="${session_name:-$(generate_name)}"

    if [[ "$use_tmate" == "true" ]]; then
        if ! command -v tmate &>/dev/null; then
            log_error "tmate not found"
            echo "Install with: brew install tmate / apt install tmate"
            exit 1
        fi

        log_info "Starting tmate session: $session_name"
        cd "$project_dir"
        tmate -S "$DATA_DIR/sockets/$session_name.sock" new-session -d -s "$session_name"
        sleep 2

        echo ""
        echo -e "${BOLD}Tmate Session Started${NC}"
        echo ""
        tmate -S "$DATA_DIR/sockets/$session_name.sock" display -p '#{tmate_ssh}'
        echo ""
        echo "Share the SSH command above with your pair partner"
        echo ""
        echo "Attach with: tmate -S $DATA_DIR/sockets/$session_name.sock attach"
        return
    fi

    # Create socket directory
    local socket_dir=$(get_socket_path)
    mkdir -p "$socket_dir"
    chmod 700 "$socket_dir"

    local socket_path="$socket_dir/$session_name.sock"

    # Check if session already exists
    if tmux -S "$socket_path" has-session -t "$session_name" 2>/dev/null; then
        log_error "Session already exists: $session_name"
        echo "Join with: pair join $session_name"
        exit 1
    fi

    # Create new tmux session with shared socket
    cd "$project_dir"
    tmux -S "$socket_path" new-session -d -s "$session_name"
    chmod 777 "$socket_path"  # Allow others to connect

    # Record session info
    cat > "$DATA_DIR/$session_name.json" << EOF
{
    "name": "$session_name",
    "started": $(date +%s),
    "project": "$project_dir",
    "mode": "$mode",
    "socket": "$socket_path",
    "host": "$USER"
}
EOF

    log_success "Pair session started: $session_name"
    echo ""
    echo -e "${BOLD}Session Info${NC}"
    echo -e "  ${CYAN}Name:${NC}    $session_name"
    echo -e "  ${CYAN}Project:${NC} $project_dir"
    echo -e "  ${CYAN}Mode:${NC}    $mode"
    echo ""
    echo -e "${BOLD}To join locally:${NC}"
    echo "  pair join $session_name"
    echo ""
    echo -e "${BOLD}To join remotely:${NC}"
    echo "  ssh $USER@$(hostname) -t 'pair join $session_name'"
    echo ""

    # Attach to session
    echo "Attaching to session..."
    tmux -S "$socket_path" attach -t "$session_name"
}

cmd_join() {
    check_tmux

    local session_name="$1"
    local readonly=false

    if [[ "$1" == "--readonly" ]]; then
        readonly=true
        session_name="$2"
    fi

    if [[ -z "$session_name" ]]; then
        # List and prompt
        cmd_list
        echo ""
        log_error "Session name required"
        echo "Usage: pair join <session-name>"
        exit 1
    fi

    local socket_path="$(get_socket_path)/$session_name.sock"

    if [[ ! -S "$socket_path" ]]; then
        log_error "Session not found: $session_name"
        echo "Use 'pair list' to see active sessions"
        exit 1
    fi

    log_info "Joining pair session: $session_name"

    # Notify host
    if command -v notify &>/dev/null; then
        notify "Partner joined: $USER" --title "Pair Session" 2>/dev/null &
    fi

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Joined pair session: $session_name" "pair" "pair_join" 2>/dev/null || true
    fi

    if [[ "$readonly" == "true" ]]; then
        tmux -S "$socket_path" attach -t "$session_name" -r
    else
        tmux -S "$socket_path" attach -t "$session_name"
    fi
}

cmd_leave() {
    # Simply detach from tmux
    if [[ -n "$TMUX" ]]; then
        tmux detach
    else
        log_info "Not in a pair session"
    fi
}

cmd_list() {
    local socket_dir=$(get_socket_path)

    if [[ ! -d "$socket_dir" ]] || [[ -z "$(ls -A "$socket_dir" 2>/dev/null)" ]]; then
        echo "No active pair sessions"
        return
    fi

    echo -e "${BOLD}Active Pair Sessions${NC}"
    echo ""

    for socket in "$socket_dir"/*.sock; do
        [[ -S "$socket" ]] || continue

        local name=$(basename "$socket" .sock)
        local info_file="$DATA_DIR/$name.json"

        echo -e "  ${CYAN}$name${NC}"

        if [[ -f "$info_file" ]]; then
            local project=$(grep '"project"' "$info_file" | cut -d'"' -f4)
            local host=$(grep '"host"' "$info_file" | cut -d'"' -f4)
            echo -e "    ${DIM}Project:${NC} $project"
            echo -e "    ${DIM}Host:${NC}    $host"
        fi

        # Show connected clients
        local clients=$(tmux -S "$socket" list-clients 2>/dev/null | wc -l | tr -d ' ')
        echo -e "    ${DIM}Clients:${NC} $clients connected"
        echo ""
    done
}

cmd_invite() {
    local session_name=""

    # Find current session if in one
    if [[ -n "$TMUX" ]]; then
        session_name=$(tmux display-message -p '#S')
    fi

    if [[ -z "$session_name" ]]; then
        # Use most recent session
        session_name=$(ls -t "$DATA_DIR"/*.json 2>/dev/null | head -1 | xargs -I{} basename {} .json)
    fi

    if [[ -z "$session_name" ]]; then
        log_error "No active session"
        echo "Start a session first: pair start"
        exit 1
    fi

    local socket_path="$(get_socket_path)/$session_name.sock"

    echo -e "${BOLD}Invite to Pair Session${NC}"
    echo ""
    echo -e "${CYAN}Session:${NC} $session_name"
    echo ""
    echo -e "${BOLD}Local (same machine):${NC}"
    echo "  pair join $session_name"
    echo ""
    echo -e "${BOLD}Remote (SSH):${NC}"
    echo "  ssh $USER@$(hostname) -t 'pair join $session_name'"
    echo ""
    echo -e "${BOLD}Direct tmux:${NC}"
    echo "  tmux -S $socket_path attach -t $session_name"
}

cmd_end() {
    local session_name="$1"

    if [[ -z "$session_name" ]] && [[ -n "$TMUX" ]]; then
        session_name=$(tmux display-message -p '#S')
    fi

    if [[ -z "$session_name" ]]; then
        log_error "Session name required"
        exit 1
    fi

    local socket_path="$(get_socket_path)/$session_name.sock"

    if [[ ! -S "$socket_path" ]]; then
        log_error "Session not found: $session_name"
        exit 1
    fi

    # Kill the session
    tmux -S "$socket_path" kill-session -t "$session_name" 2>/dev/null || true
    rm -f "$socket_path"
    rm -f "$DATA_DIR/$session_name.json"

    log_success "Pair session ended: $session_name"

    # Log to journal
    if command -v journal &>/dev/null; then
        journal log "Ended pair session: $session_name" "pair" "pair_end" 2>/dev/null || true
    fi
}

main() {
    local cmd="${1:-help}"

    case "$cmd" in
        help|--help|-h)
            cmd_help
            ;;
        start|new|create)
            shift
            cmd_start "$@"
            ;;
        join|attach|connect)
            shift
            cmd_join "$@"
            ;;
        leave|detach)
            cmd_leave
            ;;
        list|ls)
            cmd_list
            ;;
        invite|share)
            cmd_invite
            ;;
        end|kill|stop)
            shift
            cmd_end "$@"
            ;;
        version|--version|-V)
            echo "pair $PAIR_VERSION"
            ;;
        *)
            log_error "Unknown command: $cmd"
            echo "Run 'pair help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
