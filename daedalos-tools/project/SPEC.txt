================================================================================
                        PROJECT CLI SPECIFICATION
                   Pre-Computed Codebase Intelligence v1.0
================================================================================

OVERVIEW
--------
The `project` CLI provides instant codebase intelligence through pre-computed
indexes. It analyzes project structure, dependencies, conventions, and provides
summaries that would otherwise require extensive file reading.

================================================================================
                              REQUIREMENTS
================================================================================

DEPENDENCIES:
  - bash 4.0+ or python 3.10+
  - sqlite3 (for index storage)
  - tree-sitter (for code parsing) - optional, enhances accuracy
  - ripgrep (for fast file searching)
  - jq (for JSON handling)

INSTALLATION LOCATION:
  - Binary: ~/.local/bin/project
  - Library: ~/.local/lib/claude-os/project/
  - Cache: ~/.cache/claude-os/project/<project-hash>/
  - Config: ~/.config/claude-os/project/

================================================================================
                              COMMANDS
================================================================================

project summary [path]
----------------------
Shows architecture overview for a project.

Output includes:
  - Project type (Node.js, Swift, Rust, Python, Go, etc.)
  - Architecture pattern detected (MVC, MVVM, Clean, etc.)
  - Entry points
  - Key modules/directories
  - Primary dependencies
  - Detected conventions

Example output:
  ┌─────────────────────────────────────────────────────────────────┐
  │ PROJECT SUMMARY: kavara-app                                     │
  ├─────────────────────────────────────────────────────────────────┤
  │ Type: SwiftUI iOS App                                          │
  │ Architecture: MVVM + SwiftData                                 │
  │ Entry: KavaraApp.swift → ContentView → MainTabView             │
  │                                                                 │
  │ Key Modules:                                                   │
  │   • BusinessLogic/Engines/ - Core scheduling/scoring logic     │
  │   • DataLayer/Models/ - SwiftData models                       │
  │   • Presentation/Views/ - UI organized by feature              │
  │                                                                 │
  │ Dependencies: SwiftData, EventKit, UserNotifications           │
  │                                                                 │
  │ Conventions:                                                   │
  │   • Views end in "View" (TodayView, SettingsView)             │
  │   • Engines end in "Engine" (ScoringEngine)                   │
  │   • Tests mirror source structure                              │
  └─────────────────────────────────────────────────────────────────┘

Flags:
  --json          Output as JSON
  --refresh       Force re-index before showing
  --brief         One-line summary only

--------------------------------------------------------------------------------

project map [path]
------------------
Shows dependency graph and module relationships.

Output includes:
  - Directory tree with descriptions
  - Import/dependency relationships
  - Module coupling metrics

Flags:
  --depth <n>     Limit tree depth (default: 3)
  --format <fmt>  Output format: tree, dot, json
  --filter <pat>  Filter to matching paths

--------------------------------------------------------------------------------

project conventions [path]
--------------------------
Shows detected naming and organizational patterns.

Output includes:
  - File naming patterns (e.g., "*View.swift", "*Test.ts")
  - Directory organization
  - Code style patterns (indentation, quotes, etc.)
  - Common prefixes/suffixes

--------------------------------------------------------------------------------

project entry-points [path]
---------------------------
Shows main entry points and startup flow.

Output includes:
  - Main entry file(s)
  - Initialization sequence
  - Key startup components

--------------------------------------------------------------------------------

project hot-files [path]
------------------------
Shows most frequently modified files (via git history).

Output includes:
  - Files by commit count
  - Files by line churn
  - Recently modified files

Flags:
  -n <count>      Number of files to show (default: 10)
  --since <date>  Limit to commits since date

--------------------------------------------------------------------------------

project deps <file>
-------------------
Shows what a file depends on (imports).

Output:
  - Direct imports
  - Transitive dependencies (optional)
  - Missing/broken imports

Flags:
  --transitive    Include transitive dependencies
  --json          Output as JSON

--------------------------------------------------------------------------------

project dependents <file>
-------------------------
Shows what depends on a file (reverse dependencies).

Output:
  - Files that import this file
  - Potential impact of changes

Flags:
  --json          Output as JSON

--------------------------------------------------------------------------------

project search <query>
----------------------
Fast structural search (faster than grep for structure).

Examples:
  project search "class *Controller"
  project search "function handle*"
  project search "import * from 'react'"

Flags:
  --type <t>      Limit to file type
  --json          Output as JSON

--------------------------------------------------------------------------------

project index [path]
--------------------
Manually trigger re-indexing.

Flags:
  --full          Full re-index (ignore cache)
  --watch         Watch for changes and re-index
  --daemon        Run as background daemon

--------------------------------------------------------------------------------

project stats [path]
--------------------
Shows codebase statistics.

Output:
  - Lines of code by language
  - File counts by type
  - Test coverage estimate
  - Complexity metrics

================================================================================
                              DATA STRUCTURES
================================================================================

INDEX DATABASE (SQLite):
------------------------

-- Files table
CREATE TABLE files (
  id INTEGER PRIMARY KEY,
  path TEXT UNIQUE NOT NULL,
  type TEXT,              -- swift, typescript, python, etc.
  size INTEGER,
  lines INTEGER,
  modified INTEGER,       -- Unix timestamp
  hash TEXT               -- Content hash for change detection
);

-- Symbols table (functions, classes, etc.)
CREATE TABLE symbols (
  id INTEGER PRIMARY KEY,
  file_id INTEGER REFERENCES files(id),
  name TEXT NOT NULL,
  type TEXT,              -- function, class, interface, etc.
  line_start INTEGER,
  line_end INTEGER,
  signature TEXT,
  visibility TEXT         -- public, private, internal
);

-- Dependencies table
CREATE TABLE dependencies (
  id INTEGER PRIMARY KEY,
  source_file_id INTEGER REFERENCES files(id),
  target_path TEXT,       -- Import path (may be external)
  target_file_id INTEGER REFERENCES files(id),  -- NULL if external
  import_type TEXT        -- import, require, include, use
);

-- Conventions table
CREATE TABLE conventions (
  id INTEGER PRIMARY KEY,
  pattern TEXT,
  type TEXT,              -- naming, structure, style
  occurrences INTEGER,
  examples TEXT           -- JSON array of examples
);

-- Project metadata
CREATE TABLE metadata (
  key TEXT PRIMARY KEY,
  value TEXT
);

================================================================================
                              PROJECT DETECTION
================================================================================

Detect project type by presence of files:

| File                  | Project Type      |
|-----------------------|-------------------|
| package.json          | Node.js           |
| tsconfig.json         | TypeScript        |
| Cargo.toml            | Rust              |
| go.mod                | Go                |
| *.xcodeproj           | Xcode/Swift       |
| pyproject.toml        | Python (modern)   |
| setup.py              | Python (legacy)   |
| pom.xml               | Java/Maven        |
| build.gradle          | Java/Gradle       |
| Gemfile               | Ruby              |
| composer.json         | PHP               |
| mix.exs               | Elixir            |
| deno.json             | Deno              |

ARCHITECTURE DETECTION:
-----------------------
Detect patterns based on directory structure:

- src/controllers/, src/models/, src/views/ → MVC
- */ViewModels/, */Views/, */Models/ → MVVM
- domain/, application/, infrastructure/ → Clean Architecture
- features/*/ with self-contained modules → Feature-based
- components/, hooks/, pages/ → React/Component-based

================================================================================
                              PARSING STRATEGIES
================================================================================

For each language, extract:

SWIFT:
  - import statements
  - class/struct/enum/protocol definitions
  - @main entry point
  - public/internal/private visibility

TYPESCRIPT/JAVASCRIPT:
  - import/export statements
  - class/function/const definitions
  - default exports
  - React components (function returning JSX)

PYTHON:
  - import statements
  - class/function definitions
  - if __name__ == "__main__" entry points
  - decorators (@app.route, etc.)

RUST:
  - use statements
  - mod declarations
  - pub items
  - fn main entry point

GO:
  - import statements
  - package declarations
  - func main entry point
  - exported (capitalized) identifiers

================================================================================
                              CACHING STRATEGY
================================================================================

CACHE LOCATION:
  ~/.cache/claude-os/project/<hash>/

  Where <hash> = sha256(absolute_path)[:16]

CACHE CONTENTS:
  index.db          SQLite database
  meta.json         Last index time, project type, etc.

INVALIDATION:
  - Check file modification times
  - On mismatch, re-index affected files
  - Full re-index if > 20% of files changed

WATCH MODE:
  - Use fswatch/inotify to detect changes
  - Debounce rapid changes (100ms)
  - Re-index only changed files

================================================================================
                              OUTPUT FORMATTING
================================================================================

SUMMARY FORMAT:
  - Box drawing characters for structure
  - Color coding for different elements
  - Aligned columns in tables

TREE FORMAT:
  ├── directory/
  │   ├── file.ts
  │   └── subdir/
  └── other/

DOT FORMAT (for graphviz):
  digraph deps {
    "file1.ts" -> "file2.ts";
    "file2.ts" -> "lib.ts";
  }

================================================================================
                              DAEMON MODE
================================================================================

The `projectd` daemon maintains live indexes:

STARTUP:
  1. Scan ~/.config/claude-os/project/watched.json for projects
  2. Start fswatch on each project
  3. Load existing indexes
  4. Listen on Unix socket for queries

SOCKET PROTOCOL:
  - JSON-RPC over Unix socket
  - Methods: summary, map, deps, search, etc.
  - Fast queries (< 10ms for indexed data)

AUTO-DISCOVERY:
  - When `project` is run in a new directory
  - Add to watched.json
  - Start indexing in background

================================================================================
                              CONFIGURATION
================================================================================

~/.config/claude-os/project/config.yaml:
  cache_dir: ~/.cache/claude-os/project
  max_cache_size_mb: 500
  index_on_access: true
  watch_projects: true
  ignore_patterns:
    - node_modules
    - .git
    - __pycache__
    - build
    - dist
    - target
  max_file_size_kb: 1024

================================================================================
                              ERROR HANDLING
================================================================================

- If project is not indexed, index on-demand with progress
- If indexing fails, show partial results with warning
- If cache is corrupted, rebuild automatically
- Timeout long-running operations (30s default)

================================================================================
